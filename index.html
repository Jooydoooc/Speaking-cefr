<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>CEFR Speaking ‚Äì Multilevel</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg1: #0f172a;
      --bg2: #1e293b;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.16);
      --accent-strong: #0ea5e9;
      --card-bg: #020617;
      --card-border: rgba(148, 163, 184, 0.25);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #f97316;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      color: var(--text-main);
      min-height: 100vh;
      background: radial-gradient(
          circle at top left,
          rgba(56, 189, 248, 0.18),
          transparent 55%
        ),
        radial-gradient(
          circle at bottom right,
          rgba(94, 234, 212, 0.15),
          transparent 55%
        ),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      position: relative;
      overflow-x: hidden;
    }

    /* soft glow shapes */
    body::before,
    body::after {
      content: "";
      position: fixed;
      width: 420px;
      height: 420px;
      border-radius: 999px;
      filter: blur(120px);
      opacity: 0.6;
      z-index: -2;
    }
    body::before {
      background: rgba(56, 189, 248, 0.5);
      top: -120px;
      left: -60px;
    }
    body::after {
      background: rgba(129, 140, 248, 0.35);
      bottom: -160px;
      right: -40px;
    }

    .grain-overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: 0.25;
      mix-blend-mode: soft-light;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 140 140' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n' x='-20%25' y='-20%25' width='140%25' height='140%25'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.6'/%3E%3C/svg%3E");
      z-index: -1;
    }

    .app-shell {
      max-width: 1100px;
      margin: 32px auto 56px;
      padding: 0 18px 40px;
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-badge {
      width: 42px;
      height: 42px;
      border-radius: 16px;
      background: radial-gradient(
        circle at 30% 20%,
        #f9fafb,
        #e5e7eb 30%,
        #0f172a 70%
      );
      box-shadow: 0 12px 35px rgba(15, 23, 42, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
      color: #0f172a;
    }

    .brand-text h1 {
      font-size: 18px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .brand-text p {
      font-size: 12px;
      color: var(--text-muted);
    }

    .chip {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 4px 10px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text-muted);
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(10px);
    }

    .chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.7);
    }

    .card {
      background: rgba(15, 23, 42, 0.92);
      border-radius: 20px;
      border: 1px solid var(--card-border);
      box-shadow: 0 18px 60px rgba(15, 23, 42, 0.9);
      padding: 22px 20px 24px;
      backdrop-filter: blur(14px);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--text-muted);
    }

    .badge-accent {
      border-color: rgba(56, 189, 248, 0.6);
      color: var(--accent-strong);
      background: linear-gradient(
        135deg,
        rgba(56, 189, 248, 0.15),
        rgba(129, 140, 248, 0.2)
      );
    }

    .input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-top: 8px;
    }

    .field-label {
      font-size: 12px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 5px;
    }

    .field-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      padding: 9px 14px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        background 0.15s ease;
    }

    .field-input:focus {
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
      background: rgba(15, 23, 42, 0.98);
    }

    .helper-text {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 10px;
    }

    .btn-row {
      margin-top: 18px;
      display: flex;
      justify-content: flex-end;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 9px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.1s ease, box-shadow 0.1s ease,
        background 0.15s ease, opacity 0.15s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: radial-gradient(circle at 30% 0%, #e0f2fe, #0ea5e9);
      color: #0f172a;
      box-shadow: 0 12px 35px rgba(56, 189, 248, 0.45);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(56, 189, 248, 0.6);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }
    .btn-secondary:hover {
      background: rgba(15, 23, 42, 0.95);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .btn[disabled] {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* MAIN MENU */

    .grid-two {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.3fr);
      gap: 20px;
      margin-top: 12px;
    }

    .set-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .set-card {
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: radial-gradient(
          circle at top left,
          rgba(56, 189, 248, 0.12),
          transparent 55%
        ),
        rgba(15, 23, 42, 0.96);
      padding: 12px 11px 13px;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        border-color 0.12s ease, background 0.12s ease, opacity 0.12s ease;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .set-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 26px rgba(15, 23, 42, 0.9);
      border-color: rgba(56, 189, 248, 0.9);
    }

    .set-card.disabled {
      cursor: default;
      opacity: 0.4;
      box-shadow: none;
      transform: none;
    }

    .set-card.disabled:hover {
      border-color: rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.96);
    }

    .set-label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
    }

    .set-level {
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent-strong);
      font-weight: 600;
    }

    .set-name {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .set-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .pill-coming {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.6);
      color: var(--text-muted);
      margin-left: auto;
    }

    .menu-right {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .info-block {
      border-radius: 16px;
      padding: 14px 13px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: radial-gradient(
          circle at bottom right,
          rgba(94, 234, 212, 0.18),
          transparent 60%
        ),
        rgba(15, 23, 42, 0.96);
      font-size: 13px;
    }

    .info-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #e5e7eb;
    }

    .info-list {
      margin-top: 6px;
      padding-left: 18px;
      color: var(--text-muted);
    }

    .info-list li {
      margin-bottom: 4px;
    }

    .stat-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .stat-pill {
      border-radius: 999px;
      padding: 4px 9px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 11px;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent-strong);
    }

    /* SET OVERVIEW */

    .set-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.9fr) minmax(0, 1.3fr);
      gap: 18px;
      margin-top: 12px;
    }

    .section-block {
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 13px 12px 14px;
      background: rgba(15, 23, 42, 0.96);
      font-size: 14px;
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .section-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .question-list {
      list-style: none;
      padding-left: 0;
    }

    .question-list li {
      margin-bottom: 6px;
      position: relative;
      padding-left: 16px;
      color: #e5e7eb;
    }

    .question-list li::before {
      content: "‚Ä¢";
      position: absolute;
      left: 0;
      top: 0;
      color: var(--accent-strong);
    }

    .picture-wrapper {
      margin-top: 6px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 10px 28px rgba(15, 23, 42, 0.9);
    }

    .picture-wrapper img {
      width: 100%;
      display: block;
    }

    .columns-two {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    .for-block,
    .against-block {
      border-radius: 14px;
      border: 1px dashed rgba(148, 163, 184, 0.6);
      padding: 9px 10px;
      font-size: 13px;
    }

    .for-block-title {
      font-weight: 600;
      color: var(--success);
      margin-bottom: 4px;
    }

    .against-block-title {
      font-weight: 600;
      color: var(--danger);
      margin-bottom: 4px;
    }

    .mini-list {
      padding-left: 16px;
      color: var(--text-muted);
    }

    .mini-list li {
      margin-bottom: 3px;
    }

    .overview-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 14px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .small-note {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* MOCK + COMPLETION (same as before, slightly styled) */

    .mock-layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.2fr);
      gap: 18px;
      margin-top: 12px;
    }

    .timer-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .timer-value {
      font-size: 22px;
      font-weight: 700;
      color: var(--danger);
    }

    .record-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(239, 68, 68, 0.12);
      border-radius: 999px;
      padding: 5px 9px;
      font-size: 12px;
      color: #fecaca;
    }

    .record-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #f97373;
      box-shadow: 0 0 10px rgba(239, 68, 68, 0.8);
      animation: pulse 1.2s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      }
      70% {
        transform: scale(1.15);
        box-shadow: 0 0 0 7px rgba(239, 68, 68, 0);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
      }
    }

    .wave-visualizer {
      display: flex;
      align-items: flex-end;
      gap: 3px;
      height: 26px;
      margin-top: 10px;
    }

    .wave-bar {
      width: 3px;
      border-radius: 999px;
      background: linear-gradient(
        180deg,
        rgba(52, 211, 153, 1),
        rgba(16, 185, 129, 1)
      );
      transition: height 0.05s ease-out;
    }

    .notes-card {
      border-radius: 18px;
      background: radial-gradient(
          circle at top left,
          rgba(56, 189, 248, 0.25),
          transparent 55%
        ),
        rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 14px 13px 16px;
      font-size: 13px;
    }

    .notes-area {
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      padding: 9px 10px;
      font-size: 13px;
      resize: vertical;
      min-height: 110px;
      margin-top: 6px;
    }

    .notes-area::placeholder {
      color: rgba(148, 163, 184, 0.8);
    }

    .completion-screen {
      max-width: 640px;
      margin: 70px auto;
      text-align: center;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 22px;
      padding: 32px 26px 30px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      box-shadow: 0 20px 65px rgba(15, 23, 42, 0.95);
    }

    .completion-screen h2 {
      font-size: 26px;
      margin-bottom: 10px;
      color: var(--success);
    }

    .completion-screen p {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 18px;
    }

    @media (max-width: 880px) {
      .grid-two,
      .set-layout,
      .mock-layout {
        grid-template-columns: 1fr;
      }

      .app-shell {
        margin-top: 20px;
        padding-inline: 14px;
      }
    }

    @media (max-width: 600px) {
      .card {
        padding: 18px 14px 20px;
      }

      .app-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .btn-row {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="grain-overlay"></div>
  <div class="app-shell" id="app-root"></div>

  <script>
    const app = document.getElementById("app-root");

    // --- STATE -------------------------------------------------
    const speakingSets = [
      {
        id: 1,
        name: "Speaking Set 1",
        active: true,
        level: "A2‚ÄìB1",
        meta: "Everyday routine & school times",
        part1_1: [
          "What time do you usually wake up?",
          "Do you like going to the park?",
          "What do you do when you feel tired?"
        ],
        part1_2: {
          image:
            "https://i.ibb.co/pr9hGkwx/Screenshot-2025-12-03-at-00-02-09.png",
          questions: [
            "What do you see in these pictures?",
            "Why do some people like waking up early?",
            "Which do you prefer, waking up early or late, and why?"
          ]
        },
        part2: {
          main: "Talk about a time when you were late for something important.",
          prompts: [
            "What happened and how did you feel?",
            "Why is being on time important?"
          ]
        },
        part3: {
          topic: "Should schools start later in the morning?",
          for: [
            "Students need more sleep to stay healthy",
            "Late classes can help improve focus",
            "It reduces morning stress and rushing"
          ],
          against: [
            "It may shorten study hours",
            "Parents might find schedules harder",
            "Students can become lazy"
          ]
        }
      },
      ...Array.from({ length: 9 }).map((_, i) => ({
        id: i + 2,
        name: `Speaking Set ${i + 2}`,
        active: false,
        comingSoon: true,
        level: "Coming soon"
      }))
    ];

    const state = {
      page: "login", // 'login' | 'menu' | 'setOverview' | 'mock' | 'completion'
      student: {
        firstName: "",
        surname: "",
        group: "",
        date: new Date().toLocaleDateString("en-GB"),
        time: new Date().toLocaleTimeString("en-GB", {
          hour: "2-digit",
          minute: "2-digit"
        })
      },
      selectedSet: null,
      isInMock: false,
      currentPart: null,
      timer: 0,
      prepTimer: 0,
      phase: "prepare",
      isRecording: false,
      audioBlob: null,
      mediaRecorder: null,
      audioChunks: [],
      audioContext: null,
      analyser: null,
      stream: null,
      timerInterval: null,
      voiceBars: Array.from({ length: 20 }).map(() => 5),
      notes: "",
      _blobPromise: null,
      _blobResolve: null
    };

    // --- RENDER ROOT -------------------------------------------
    function render() {
      if (state.page === "login") {
        renderLogin();
      } else if (state.page === "menu") {
        renderMenu();
      } else if (state.page === "setOverview") {
        renderSetOverview();
      } else if (state.page === "mock") {
        renderMock();
      } else if (state.page === "completion") {
        renderCompletion();
      }
    }

    // --- LOGIN PAGE --------------------------------------------
    function renderLogin() {
      app.innerHTML = `
        <header class="app-header">
          <div class="brand">
            <div class="brand-badge">S</div>
            <div class="brand-text">
              <h1>CEFR Speaking Lab</h1>
              <p>Multi-level speaking practice with auto Telegram sending</p>
            </div>
          </div>
          <div class="chip">
            <span class="chip-dot"></span>
            Live session ¬∑ Teacher view on Telegram
          </div>
        </header>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Log in to start speaking</div>
              <div class="card-subtitle">
                Please enter your details carefully. Your teacher will receive your name and group with the recording.
              </div>
            </div>
            <span class="badge badge-accent">Student login</span>
          </div>

          <div class="input-grid">
            <div>
              <div class="field-label">First name</div>
              <input id="firstName" class="field-input" placeholder="e.g. Doniyor" value="${
                state.student.firstName
              }" />
            </div>
            <div>
              <div class="field-label">Surname</div>
              <input id="surname" class="field-input" placeholder="e.g. Eshmurodov" value="${
                state.student.surname
              }" />
            </div>
            <div>
              <div class="field-label">Group</div>
              <input id="group" class="field-input" placeholder="e.g. CEFR B1 - Everest" value="${
                state.student.group
              }" />
            </div>
          </div>

          <p class="helper-text">
            Make sure you write your group name exactly as your teacher told you. This will help with checking your scores later.
          </p>

          <div class="btn-row">
            <button class="btn btn-primary" onclick="handleLogin()">
              Continue to Main Menu
              <span>‚Üí</span>
            </button>
          </div>
        </section>
      `;
    }

    function handleLogin() {
      const firstName = document.getElementById("firstName").value.trim();
      const surname = document.getElementById("surname").value.trim();
      const group = document.getElementById("group").value.trim();

      if (!firstName || !surname || !group) {
        alert("Please fill in your first name, surname and group.");
        return;
      }

      state.student.firstName = firstName;
      state.student.surname = surname;
      state.student.group = group;
      state.page = "menu";
      render();
    }

    // --- MAIN MENU ---------------------------------------------
    function renderMenu() {
      const activeCount = speakingSets.filter((s) => s.active).length;

      app.innerHTML = `
        <header class="app-header">
          <div class="brand">
            <div class="brand-badge">S</div>
            <div class="brand-text">
              <h1>CEFR Speaking Lab</h1>
              <p>${state.student.firstName || "Student"} ${
        state.student.surname || ""
      } ¬∑ ${state.student.group || "Unknown group"}</p>
            </div>
          </div>
          <div class="chip">
            <span class="chip-dot"></span>
            ${activeCount} active set${
        activeCount !== 1 ? "s" : ""
      } ¬∑ ${new Date().toLocaleDateString("en-GB")}
          </div>
        </header>

        <section class="grid-two">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Main Menu ¬∑ Choose your set</div>
                <div class="card-subtitle">
                  Only Set 1 is available now. The other 9 sets are coming soon.
                </div>
              </div>
              <span class="badge">10 sets in total</span>
            </div>

            <div class="set-grid">
              ${speakingSets
                .map((set) => {
                  if (!set.active) {
                    return `
                      <div class="set-card disabled">
                        <div class="set-label-row">
                          <span class="set-name">${set.name}</span>
                          <span class="pill-coming">Coming soon</span>
                        </div>
                        <div class="set-meta">${set.level}</div>
                      </div>
                    `;
                  }
                  return `
                    <div class="set-card" onclick="selectSet(${
                      set.id
                    })">
                      <div class="set-label-row">
                        <span class="set-name">${set.name}</span>
                        <span class="set-level">${set.level}</span>
                      </div>
                      <div class="set-meta">${set.meta}</div>
                    </div>
                  `;
                })
                .join("")}
            </div>
          </div>

          <aside class="menu-right">
            <div class="info-block">
              <div class="info-title">How this speaking test works</div>
              <p>
                After you choose a set, you will first see <strong>all questions</strong>. When you feel ready, click
                <strong>Start Speaking</strong>. Your microphone will turn on and you will answer Part 1, 2 and 3 without stopping.
              </p>
              <ul class="info-list">
                <li>Remember to speak clearly and naturally.</li>
                <li>Try to follow real exam timing.</li>
                <li>Your recording is sent to your teacher on Telegram.</li>
              </ul>
            </div>

            <div class="info-block">
              <div class="info-title">Session details</div>
              <div class="stat-row">
                <div class="stat-pill">
                  <span class="dot"></span>
                  Name: ${state.student.firstName} ${state.student.surname}
                </div>
                <div class="stat-pill">
                  üë• Group: ${state.student.group}
                </div>
                <div class="stat-pill">
                  üìÖ ${state.student.date}
                </div>
                <div class="stat-pill">
                  ‚è∞ ${state.student.time}
                </div>
              </div>
            </div>
          </aside>
        </section>
      `;
    }

    function selectSet(id) {
      const set = speakingSets.find((s) => s.id === id);
      if (!set || !set.active) return;
      state.selectedSet = set;
      state.page = "setOverview";
      render();
    }

    // --- SET OVERVIEW (all questions + Start button) -----------
    function renderSetOverview() {
      const set = state.selectedSet;
      if (!set) {
        state.page = "menu";
        render();
        return;
      }

      app.innerHTML = `
        <header class="app-header">
          <div class="brand">
            <div class="brand-badge">S</div>
            <div class="brand-text">
              <h1>${set.name}</h1>
              <p>Student: ${state.student.firstName} ${
        state.student.surname
      } ¬∑ Group: ${state.student.group}</p>
            </div>
          </div>
          <button class="btn btn-secondary" onclick="backToMenu()">
            ‚Üê Back to Main Menu
          </button>
        </header>

        <section class="set-layout">
          <div class="section-block">
            <div class="section-title">Part 1.1 ‚Äì Short questions</div>
            <div class="section-sub">
              You will answer simple questions about your daily life. Speak in full sentences.
            </div>
            <ul class="question-list">
              ${set.part1_1
                .map((q, i) => `<li>${i + 1}. ${q}</li>`)
                .join("")}
            </ul>

            <div style="margin-top:12px; border-top:1px dashed rgba(148,163,184,0.4); padding-top:11px;">
              <div class="section-title">Part 1.2 ‚Äì Picture questions</div>
              <div class="section-sub">
                Look at the picture and answer the questions.
              </div>
              <div class="picture-wrapper">
                <img src="${set.part1_2.image}" alt="Speaking pictures" />
              </div>
              <ul class="question-list" style="margin-top:10px;">
                ${set.part1_2.questions
                  .map((q, i) => `<li>${i + 1}. ${q}</li>`)
                  .join("")}
              </ul>
            </div>
          </div>

          <div class="section-block">
            <div class="section-title">Part 2 ‚Äì Long turn</div>
            <div class="section-sub">
              You will have 1 minute to prepare and then 1‚Äì2 minutes to talk about this topic.
            </div>
            <p style="margin-bottom:6px;">
              <strong>${set.part2.main}</strong>
            </p>
            <ul class="question-list">
              ${set.part2.prompts
                .map((p) => `<li>${p}</li>`)
                .join("")}
            </ul>

            <div style="margin-top:14px; border-top:1px dashed rgba(148,163,184,0.4); padding-top:10px;">
              <div class="section-title">Part 3 ‚Äì Discussion</div>
              <div class="section-sub">
                Topic: <strong>${set.part3.topic}</strong>
              </div>
              <div class="columns-two">
                <div class="for-block">
                  <div class="for-block-title">FOR (yes, start later)</div>
                  <ul class="mini-list">
                    ${set.part3.for
                      .map((p) => `<li>${p}</li>`)
                      .join("")}
                  </ul>
                </div>
                <div class="against-block">
                  <div class="against-block-title">AGAINST (no, keep early)</div>
                  <ul class="mini-list">
                    ${set.part3.against
                      .map((p) => `<li>${p}</li>`)
                      .join("")}
                  </ul>
                </div>
              </div>
            </div>

            <div class="overview-footer">
              <p class="small-note">
                When you click <strong>Start Speaking</strong>, your microphone will turn on and the timer will begin.
                You will answer all parts without stopping the recording.
              </p>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button class="btn btn-secondary" onclick="backToMenu()">Back</button>
                <button class="btn btn-primary" onclick="startMockTest()">
                  Start Speaking Now
                  <span>üéôÔ∏è</span>
                </button>
              </div>
            </div>
          </div>
        </section>
      `;
    }

    function backToMenu() {
      state.selectedSet = null;
      state.page = "menu";
      render();
    }

    // --- MOCK TEST (recording, timers) -------------------------
    async function startMockTest() {
      const set = state.selectedSet;
      if (!set) return;

      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: true
        });
        state.stream = stream;
        state.mediaRecorder = new MediaRecorder(stream);
        state.audioChunks = [];
        state.audioBlob = null;
        state._blobPromise = new Promise((resolve) => {
          state._blobResolve = resolve;
        });

        state.mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) state.audioChunks.push(e.data);
        };
        state.mediaRecorder.onstop = () => {
          const mime =
            state.audioChunks[0]?.type ||
            state.mediaRecorder.mimeType ||
            "audio/webm";
          const blob = new Blob(state.audioChunks, { type: mime });
          state.audioBlob = blob;
          if (state._blobResolve) {
            state._blobResolve(blob);
            state._blobResolve = null;
          }
        };

        state.audioContext =
          new (window.AudioContext || window.webkitAudioContext)();
        const source = state.audioContext.createMediaStreamSource(stream);
        state.analyser = state.audioContext.createAnalyser();
        state.analyser.fftSize = 256;
        source.connect(state.analyser);

        state.voiceBars = Array.from({ length: 20 }).map(() => 5);

        state.isRecording = true;
        state.isInMock = true;
        state.currentPart = "part1_1";
        state.phase = "prepare";
        state.prepTimer = 30;
        state.timer = 0;

        state.mediaRecorder.start();
        render();
        startVisualizer();
        startPartTimer();
      } catch (err) {
        console.error(err);
        alert(
          "Could not access your microphone. Please allow microphone access and try again."
        );
      }
    }

    function startVisualizer() {
      if (!state.analyser) return;
      const bufferLength = state.analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);

      function draw() {
        if (!state.analyser || !state.isRecording) return;
        state.analyser.getByteFrequencyData(dataArray);
        state.voiceBars = state.voiceBars.map((_, index) => {
          const idx = Math.floor(
            index * (bufferLength / state.voiceBars.length)
          );
          const value = dataArray[idx] / 255;
          const height = Math.max(5, Math.floor(value * 26));
          return height;
        });

        const container = document.getElementById("waveVisualizer");
        if (container) {
          container.innerHTML = state.voiceBars
            .map(
              (h) => `<div class="wave-bar" style="height:${h}px"></div>`
            )
            .join("");
        }
        requestAnimationFrame(draw);
      }

      draw();
    }

    function startPartTimer() {
      clearInterval(state.timerInterval);
      state.timerInterval = setInterval(() => {
        if (!state.isInMock) {
          clearInterval(state.timerInterval);
          return;
        }
        if (state.phase === "prepare") {
          if (state.prepTimer > 0) {
            state.prepTimer--;
          } else {
            state.phase = "speaking";
            if (state.currentPart === "part2") {
              state.timer = 2 * 60;
            } else {
              state.timer = 4 * 60;
            }
          }
        } else if (state.phase === "speaking") {
          if (state.timer > 0) {
            state.timer--;
          } else {
            moveToNextPart();
          }
        }
        render();
      }, 1000);
    }

    function moveToNextPart() {
      if (state.currentPart === "part1_1") {
        state.currentPart = "part1_2";
        state.phase = "prepare";
        state.prepTimer = 30;
        state.timer = 0;
        startPartTimer();
      } else if (state.currentPart === "part1_2") {
        state.currentPart = "part2";
        state.phase = "prepare";
        state.prepTimer = 60;
        state.timer = 0;
        startPartTimer();
      } else if (state.currentPart === "part2") {
        state.currentPart = "part3";
        state.phase = "prepare";
        state.prepTimer = 60;
        state.timer = 0;
        startPartTimer();
      } else if (state.currentPart === "part3") {
        finishMockTest();
      }
    }

    async function finishMockTest() {
      clearInterval(state.timerInterval);
      if (state.mediaRecorder && state.isRecording) {
        try {
          state.mediaRecorder.stop();
        } catch {}
        if (state._blobPromise) {
          try {
            await state._blobPromise;
          } catch {}
        }
      }

      if (state.audioContext) {
        try {
          await state.audioContext.close();
        } catch {}
      }
      if (state.stream) {
        state.stream.getTracks().forEach((t) => t.stop());
        state.stream = null;
      }

      state.isRecording = false;
      state.isInMock = false;
      state.page = "completion";
      render();
      sendToTelegram();
    }

    function getPartLabel() {
      if (state.currentPart === "part1_1")
        return "Part 1.1 ‚Äì Short questions";
      if (state.currentPart === "part1_2")
        return "Part 1.2 ‚Äì Picture questions";
      if (state.currentPart === "part2") return "Part 2 ‚Äì Long turn";
      if (state.currentPart === "part3") return "Part 3 ‚Äì Discussion";
      return "Speaking Test";
    }

    function getPartContent() {
      const set = state.selectedSet;
      if (!set) return "";
      if (state.currentPart === "part1_1") {
        return `
          <p style="font-size:14px; color:var(--text-muted); margin-bottom:6px;">
            Answer these simple questions about your daily life.
          </p>
          <ul class="question-list">
            ${set.part1_1
              .map((q, i) => `<li>${i + 1}. ${q}</li>`)
              .join("")}
          </ul>
        `;
      }
      if (state.currentPart === "part1_2") {
        return `
          <p style="font-size:14px; color:var(--text-muted); margin-bottom:6px;">
            Look at the picture and answer the questions.
          </p>
          <div class="picture-wrapper" style="margin-bottom:8px;">
            <img src="${set.part1_2.image}" alt="Pictures" />
          </div>
          <ul class="question-list">
            ${set.part1_2.questions
              .map((q, i) => `<li>${i + 1}. ${q}</li>`)
              .join("")}
          </ul>
        `;
      }
      if (state.currentPart === "part2") {
        return `
          <p style="font-size:14px; color:var(--text-muted); margin-bottom:6px;">
            You have 1 minute to prepare and then 1‚Äì2 minutes to speak.
          </p>
          <p><strong>${set.part2.main}</strong></p>
          <ul class="question-list" style="margin-top:6px;">
            ${set.part2.prompts.map((p) => `<li>${p}</li>`).join("")}
          </ul>
        `;
      }
      if (state.currentPart === "part3") {
        return `
          <p style="font-size:14px; color:var(--text-muted); margin-bottom:6px;">
            Topic: <strong>${set.part3.topic}</strong>
          </p>
          <div class="columns-two">
            <div class="for-block">
              <div class="for-block-title">FOR</div>
              <ul class="mini-list">
                ${set.part3.for.map((p) => `<li>${p}</li>`).join("")}
              </ul>
            </div>
            <div class="against-block">
              <div class="against-block-title">AGAINST</div>
              <ul class="mini-list">
                ${set.part3.against.map((p) => `<li>${p}</li>`).join("")}
              </ul>
            </div>
          </div>
        `;
      }
      return "";
    }

    function renderMock() {
      const set = state.selectedSet;
      if (!set) {
        state.page = "menu";
        render();
        return;
      }

      app.innerHTML = `
        <header class="app-header">
          <div class="brand">
            <div class="brand-badge">S</div>
            <div class="brand-text">
              <h1>${set.name} ¬∑ Live speaking</h1>
              <p>${state.student.firstName} ${
        state.student.surname
      } ¬∑ ${state.student.group}</p>
            </div>
          </div>
          <button class="btn btn-secondary" onclick="finishMockTest()">
            Finish & Save
          </button>
        </header>

        <section class="mock-layout">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">${getPartLabel()}</div>
                <div class="card-subtitle">
                  ${
                    state.phase === "prepare"
                      ? "Preparation time ‚Äì think about your ideas."
                      : "Speaking time ‚Äì answer as in the real exam."
                  }
                </div>
              </div>
              <span class="badge badge-accent">
                ${
                  state.phase === "prepare"
                    ? "Prepare"
                    : "Speak"
                }
              </span>
            </div>

            <div class="section-block" style="margin-bottom:12px;">
              ${getPartContent()}
            </div>

            <div style="display:flex; align-items:center; gap:12px;">
              <div>
                <div class="timer-label">${
                  state.phase === "prepare"
                    ? "Preparation time"
                    : "Speaking time"
                }</div>
                <div class="timer-value">${
                  state.phase === "prepare"
                    ? formatTime(state.prepTimer)
                    : formatTime(state.timer)
                }</div>
              </div>
              <div style="margin-left:auto; text-align:right;">
                <div class="record-indicator">
                  <span class="record-dot"></span>
                  <span>Recording...</span>
                </div>
              </div>
            </div>

            <div id="waveVisualizer" class="wave-visualizer">
              ${state.voiceBars
                .map(
                  (h) =>
                    `<div class="wave-bar" style="height:${h}px"></div>`
                )
                .join("")}
            </div>
          </div>

          <aside class="notes-card">
            <div class="info-title">Notes / keywords</div>
            <p style="color:var(--text-muted); margin-bottom:6px;">
              Use this space to write a few keywords, but do not read full sentences.
            </p>
            <textarea
              id="notesArea"
              class="notes-area"
              placeholder="Write short notes only..."
              oninput="handleNotesChange()"
            >${escapeHtml(state.notes)}</textarea>
          </aside>
        </section>
      `;
    }

    function handleNotesChange() {
      const el = document.getElementById("notesArea");
      if (el) state.notes = el.value;
    }

    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${m}:${s.toString().padStart(2, "0")}`;
    }

    // --- COMPLETION --------------------------------------------
    function renderCompletion() {
      app.innerHTML = `
        <header class="app-header">
          <div class="brand">
            <div class="brand-badge">S</div>
            <div class="brand-text">
              <h1>Speaking test finished</h1>
              <p>${state.student.firstName} ${
        state.student.surname
      } ¬∑ ${state.student.group}</p>
            </div>
          </div>
        </header>

        <section class="completion-screen">
          <h2>‚úÖ Well done!</h2>
          <p>
            You have finished your speaking test. Your recording is being sent to your teacher on Telegram.
            You can also download it for self-practice.
          </p>
          <button class="btn btn-primary" onclick="downloadRecording()">
            Download my recording
          </button>
          <div style="margin-top:16px;">
            <button class="btn btn-secondary" onclick="backToMenuFromCompletion()">
              Back to Main Menu
            </button>
          </div>
        </section>
      `;
    }

    function backToMenuFromCompletion() {
      state.page = "menu";
      render();
    }

    function downloadRecording() {
      if (!state.audioBlob) {
        alert("No recording available.");
        return;
      }
      const fileName = `${state.student.firstName}_${state.student.surname}_${
        state.student.group
      }_Set${state.selectedSet?.id || 1}_${
        state.student.date
      }_${state.student.time.replace(/:/g, "-")}.webm`;
      const url = URL.createObjectURL(state.audioBlob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // --- TELEGRAM SENDER (via /api/sendRecording) --------------
    async function sendToTelegram() {
      if (!state.audioBlob || !state.selectedSet) return;
      try {
        const base64Audio = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => {
            const result = reader.result || "";
            const base64 =
              typeof result === "string" && result.includes(",")
                ? result.split(",")[1]
                : result;
            resolve(base64);
          };
          reader.onerror = () =>
            reject(reader.error || new Error("Failed to read audio blob"));
          reader.readAsDataURL(state.audioBlob);
        });

        const res = await fetch("/api/sendRecording", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            firstName: state.student.firstName,
            surname: state.student.surname,
            group: state.student.group,
            setName: state.selectedSet.name,
            date: state.student.date,
            time: state.student.time,
            audioBase64: base64Audio
          })
        });

        const data = await res.json();
        if (!res.ok || !data.ok) {
          console.error("Telegram error:", data);
          alert(
            "Recording saved here, but sending to Telegram failed. Please tell your teacher."
          );
        } else {
          console.log("Sent to Telegram");
        }
      } catch (err) {
        console.error("sendToTelegram error:", err);
        alert(
          "Recording saved here, but sending to Telegram failed. Please tell your teacher."
        );
      }
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    // make some functions global for HTML handlers
    window.handleLogin = handleLogin;
    window.selectSet = selectSet;
    window.backToMenu = backToMenu;
    window.startMockTest = startMockTest;
    window.finishMockTest = finishMockTest;
    window.handleNotesChange = handleNotesChange;
    window.downloadRecording = downloadRecording;
    window.backToMenuFromCompletion = backToMenuFromCompletion;

    // initial render
    render();
  </script>
</body>
</html>
