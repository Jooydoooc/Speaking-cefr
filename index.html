<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IELTS Speaking Test – Set 1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%, #000 100%);
      color: #f9fafb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 12px;
    }
    .app {
      width: 100%;
      max-width: 960px;
    }
    .card {
      background: rgba(2, 6, 23, 0.96);
      border-radius: 24px;
      padding: 20px 18px;
      box-shadow: 0 22px 45px rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }
    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .title-block h1 {
      font-size: 1.3rem;
      margin: 0;
    }
    .subtitle {
      font-size: 0.85rem;
      color: #9ca3af;
    }
    .timer {
      font-weight: 600;
      font-size: 1.05rem;
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
    }
    .fields-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }
    .fields-row input {
      flex: 1 1 140px;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #f9fafb;
      outline: none;
      font-size: 0.92rem;
    }
    .fields-row input::placeholder {
      color: #6b7280;
    }
    .fields-row input:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
    }
    .btn {
      border-radius: 999px;
      padding: 10px 22px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.12s ease;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #a3e635);
      color: #022c22;
      box-shadow: 0 10px 22px rgba(34, 197, 94, 0.5);
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(34, 197, 94, 0.65);
    }
    .btn-primary:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 8px 18px rgba(34, 197, 94, 0.45);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }
    .content {
      margin-top: 10px;
      padding: 14px 10px;
      border-radius: 18px;
      background: radial-gradient(circle at top left, rgba(15, 118, 110, 0.25), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.25), transparent 60%),
                  rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(31, 41, 55, 0.9);
      min-height: 230px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 10px;
    }
    .section-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
    }
    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #a5b4fc;
    }
    .questions {
      font-size: 0.96rem;
      line-height: 1.55;
      white-space: pre-line;
      color: #e5e7eb;
    }
    .transition-text {
      font-size: 1.25rem;
      font-weight: 700;
      text-align: center;
    }
    .status {
      margin-top: 10px;
      font-size: 0.86rem;
      color: #9ca3af;
    }
    audio {
      margin-top: 6px;
      width: 100%;
    }
    @media (max-width: 640px) {
      .card {
        border-radius: 16px;
        padding: 14px 12px;
      }
      .content {
        padding: 12px 9px;
        min-height: 200px;
      }
      .header {
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="header">
        <div class="title-block">
          <h1>IELTS Speaking – Set 1</h1>
          <div class="subtitle">The whole test is recorded and sent to your teacher automatically.</div>
        </div>
        <div class="timer">Time: <span id="timerDisplay">00:00</span></div>
      </div>

      <div class="fields-row">
        <input id="studentName" type="text" placeholder="Student name" />
        <input id="groupName" type="text" placeholder="Group name" />
        <button id="startBtn" class="btn btn-primary">Start Test</button>
      </div>

      <div id="content" class="content">
        <div class="section-label">Welcome</div>
        <div class="section-title">How it works</div>
        <div class="questions">
          1. Enter your name and group.{"\n"}
          2. Click <strong>Start Test</strong>.{"\n"}
          3. The test will move automatically through:{"\n"}
             • Part 1.1 → Part 1.2{"\n"}
             • Part 2 (preparation + speaking){"\n"}
             • Part 3 (preparation + speaking){"\n"}
          4. There will be a short 4-second screen: “Let’s move to …” between each part.{"\n"}
          5. At the end, your full recording is sent to your teacher on Telegram.
        </div>
      </div>

      <div id="status" class="status"></div>
      <audio id="audioPreview" controls style="display:none;"></audio>
    </div>
  </div>

  <script>
    const startBtn      = document.getElementById('startBtn');
    const contentEl     = document.getElementById('content');
    const timerDisplay  = document.getElementById('timerDisplay');
    const statusEl      = document.getElementById('status');
    const audioPreview  = document.getElementById('audioPreview');
    const studentNameEl = document.getElementById('studentName');
    const groupNameEl   = document.getElementById('groupName');

    let mediaRecorder;
    let recordedChunks = [];
    let currentStepIndex = 0;
    let stepTimerId = null;
    let countdownId = null;

    // --------- STEPS (with 4-second transitions) ---------
    const steps = [
      // Part 1.1 – speaking
      { type: 'part', mode: 'speak', id: 'part1_1', label: 'Part 1.1', duration: 90 },

      // 4-second interval
      { type: 'transition', fromLabel: 'Part 1.1', toLabel: 'Part 1.2', duration: 4 },

      // Part 1.2 – speaking
      { type: 'part', mode: 'speak', id: 'part1_2', label: 'Part 1.2', duration: 90 },

      // 4-second interval
      { type: 'transition', fromLabel: 'Part 1.2', toLabel: 'Part 2 – preparation', duration: 4 },

      // Part 2 – preparation time
      { type: 'prep', id: 'part2', label: 'Part 2 – Preparation', duration: 60 },

      // Part 2 – speaking
      { type: 'part', mode: 'speak', id: 'part2', label: 'Part 2 – Speaking', duration: 120 },

      // 4-second interval
      { type: 'transition', fromLabel: 'Part 2', toLabel: 'Part 3 – preparation', duration: 4 },

      // Part 3 – preparation time
      { type: 'prep', id: 'part3', label: 'Part 3 – Preparation', duration: 60 },

      // Part 3 – speaking
      { type: 'part', mode: 'speak', id: 'part3', label: 'Part 3 – Speaking', duration: 180 }
    ];

    // --------- QUESTIONS & CONTENT ---------
    const questionsByPart = {
      part1_1: {
        title: 'Work & Study',
        text: [
          '1. Are you a student, or do you work?',
          '2. Why did you choose that job?',
          '3. Do you like your job?',
          '4. What do you dislike about your study?',
          '5. What kind of bags do you use?',
          '6. What bags are comfortable when you travel: small bags or big ones?'
        ].join('\\n')
      },
      part1_2: {
        title: 'Follow-up Questions',
        text: [
          '(Add your Part 1.2 questions here.)',
          'Keep speaking until the time finishes.'
        ].join('\\n')
      },
      part2: {
        title: 'Describe the film you were disappointed in',
        text: [
          'You should say:',
          '• what film it was',
          '• when you watched it',
          '• why it disappointed you',
          '',
          'and explain how you felt about it overall.'
        ].join('\\n'),
        prepNote: 'You have 1 minute to prepare. Read the whole task carefully and think of your ideas and examples.'
      },
      part3: {
        title: 'Discussion – Films & Actors',
        text: [
          '1. Are actors’ and actresses’ lives interesting?',
          '2. Should there be a difference in paying actors and actresses?',
          '3. What kind of movies are popular in your country?',
          '4. Should the government spend more money on films?'
        ].join('\\n'),
        // Arguments for and against – shown in preparation + speaking
        arguments: [
          'Possible arguments FOR:',
          '• Films create jobs and support the economy.',
          '• Famous actors can be good role models.',
          '• Movies can educate people about history and cultures.',
          '',
          'Possible arguments AGAINST:',
          '• Actors sometimes earn much more than teachers or doctors.',
          '• Some films show violence or unhealthy behaviour.',
          '• Governments may have more important areas to invest in (healthcare, education, etc.).'
        ].join('\\n')
      }
    };

    // --------- TIMER UTILITIES ---------
    function formatTime(totalSeconds) {
      const m = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
      const s = String(totalSeconds % 60).padStart(2, '0');
      return \`\${m}:\${s}\`;
    }

    function updateTimerDisplay(secondsLeft) {
      timerDisplay.textContent = formatTime(secondsLeft);
    }

    function clearAllTimers() {
      if (stepTimerId) {
        clearTimeout(stepTimerId);
        stepTimerId = null;
      }
      if (countdownId) {
        clearInterval(countdownId);
        countdownId = null;
      }
    }

    // --------- MAIN FLOW ---------
    async function startTest() {
      const name = studentNameEl.value.trim();
      const group = groupNameEl.value.trim();

      if (!name || !group) {
        alert('Please enter your name and group before starting the test.');
        return;
      }

      startBtn.disabled = true;
      statusEl.textContent = 'Requesting microphone access…';

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        recordedChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            recordedChunks.push(event.data);
          }
        };

        mediaRecorder.onstop = handleRecordingComplete;

        // Start one long recording for the whole test
        mediaRecorder.start();
        statusEl.textContent = 'Recording… Speak clearly and follow the instructions.';

        currentStepIndex = 0;
        runCurrentStep();
      } catch (err) {
        console.error(err);
        alert('Could not access microphone. Please allow microphone permission.');
        startBtn.disabled = false;
        statusEl.textContent = 'Microphone access denied.';
      }
    }

    function runCurrentStep() {
      clearAllTimers();

      if (currentStepIndex >= steps.length) {
        finishTest();
        return;
      }

      const step = steps[currentStepIndex];

      if (step.type === 'part') {
        runPartStep(step);
      } else if (step.type === 'prep') {
        runPrepStep(step);
      } else if (step.type === 'transition') {
        runTransitionStep(step);
      }
    }

    function runPartStep(step) {
      const { id, label, duration } = step;
      const q = questionsByPart[id];

      contentEl.innerHTML = '';

      const sectionLabel = document.createElement('div');
      sectionLabel.className = 'section-label';
      sectionLabel.textContent = 'Speaking time';

      const title = document.createElement('div');
      title.className = 'section-title';
      title.textContent = label + (q?.title ? ' – ' + q.title : '');

      const questions = document.createElement('div');
      questions.className = 'questions';

      let fullText = q?.text || '(No questions defined yet)';
      if (id === 'part3' && q?.arguments) {
        fullText += '\\n\\n' + q.arguments;
      }

      questions.textContent = fullText;

      contentEl.appendChild(sectionLabel);
      contentEl.appendChild(title);
      contentEl.appendChild(questions);

      let secondsLeft = duration;
      updateTimerDisplay(secondsLeft);

      countdownId = setInterval(() => {
        secondsLeft--;
        updateTimerDisplay(secondsLeft);
        if (secondsLeft <= 0) {
          clearInterval(countdownId);
        }
      }, 1000);

      stepTimerId = setTimeout(() => {
        currentStepIndex++;
        runCurrentStep();
      }, duration * 1000);
    }

    function runPrepStep(step) {
      const { id, label, duration } = step;
      const q = questionsByPart[id];

      contentEl.innerHTML = '';

      const sectionLabel = document.createElement('div');
      sectionLabel.className = 'section-label';
      sectionLabel.textContent = 'Preparation time';

      const title = document.createElement('div');
      title.className = 'section-title';
      title.textContent = label + (q?.title ? ' – ' + q.title : '');

      const questions = document.createElement('div');
      questions.className = 'questions';

      let fullText = q?.text || '';
      if (id === 'part2' && q?.prepNote) {
        fullText = q.prepNote + '\\n\\n' + fullText;
      }
      if (id === 'part3' && q?.arguments) {
        fullText = 'Use this time to read the questions and think of arguments.' + '\\n\\n' + q.text + '\\n\\n' + q.arguments;
      }

      questions.textContent = fullText || '(No content defined yet)';

      contentEl.appendChild(sectionLabel);
      contentEl.appendChild(title);
      contentEl.appendChild(questions);

      let secondsLeft = duration;
      updateTimerDisplay(secondsLeft);

      countdownId = setInterval(() => {
        secondsLeft--;
        updateTimerDisplay(secondsLeft);
        if (secondsLeft <= 0) {
          clearInterval(countdownId);
        }
      }, 1000);

      stepTimerId = setTimeout(() => {
        currentStepIndex++;
        runCurrentStep();
      }, duration * 1000);
    }

    function runTransitionStep(step) {
      const { fromLabel, toLabel, duration } = step;

      contentEl.innerHTML = '';
      const label = document.createElement('div');
      label.className = 'section-label';
      label.textContent = 'Transition';

      const message = document.createElement('div');
      message.className = 'transition-text';
      message.textContent = \`Let’s move to \${toLabel}.\`;

      const note = document.createElement('div');
      note.className = 'questions';
      note.style.textAlign = 'center';
      note.textContent = 'Get ready for the next part. Do not stop speaking for a long time during the test.';

      contentEl.appendChild(label);
      contentEl.appendChild(message);
      contentEl.appendChild(note);

      let secondsLeft = duration;
      updateTimerDisplay(secondsLeft);

      countdownId = setInterval(() => {
        secondsLeft--;
        updateTimerDisplay(secondsLeft);
        if (secondsLeft <= 0) {
          clearInterval(countdownId);
        }
      }, 1000);

      stepTimerId = setTimeout(() => {
        currentStepIndex++;
        runCurrentStep();
      }, duration * 1000);
    }

    function finishTest() {
      clearAllTimers();
      contentEl.innerHTML = '';

      const label = document.createElement('div');
      label.className = 'section-label';
      label.textContent = 'Finished';

      const title = document.createElement('div');
      title.className = 'section-title';
      title.textContent = 'Test finished ✅';

      const text = document.createElement('div');
      text.className = 'questions';
      text.textContent = 'Please wait while your recording is being processed and sent to your teacher on Telegram.';

      contentEl.appendChild(label);
      contentEl.appendChild(title);
      contentEl.appendChild(text);
      updateTimerDisplay(0);

      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        statusEl.textContent = 'Stopping recording…';
        mediaRecorder.stop();
      } else {
        statusEl.textContent = 'Recording already stopped.';
        startBtn.disabled = false;
      }
    }

    async function handleRecordingComplete() {
      try {
        const blob = new Blob(recordedChunks, { type: 'audio/webm' });
        const url = URL.createObjectURL(blob);
        audioPreview.src = url;
        audioPreview.style.display = 'block';

        statusEl.textContent = 'Uploading recording to teacher…';

        await uploadRecordingToServer(blob);
        statusEl.textContent = 'Recording uploaded successfully ✅';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Error uploading recording. Please tell your teacher.';
      } finally {
        startBtn.disabled = false;
      }
    }

    // Convert Blob -> base64 so we can send JSON to the API
    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const dataUrl = reader.result;
          const base64 = String(dataUrl).split(',')[1] || '';
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    async function uploadRecordingToServer(blob) {
      const audioBase64 = await blobToBase64(blob);
      const payload = {
        audioBase64,
        mimeType: blob.type,
        studentName: studentNameEl.value.trim(),
        groupName: groupNameEl.value.trim()
      };

      const response = await fetch('/api/sendRecording', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const text = await response.text();
        throw new Error('Upload failed: ' + text);
      }
    }

    startBtn.addEventListener('click', startTest);
  </script>
</body>
</html>
