<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CEFR Speaking ‚Äì Multilevel</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg1: #020617;
      --bg2: #0f172a;
      --accent: #38bdf8;
      --accent-strong: #0ea5e9;
      --accent-soft: rgba(56, 189, 248, 0.2);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --card-bg: rgba(15, 23, 42, 0.96);
      --border: rgba(148, 163, 184, 0.4);
      --danger: #ef4444;
      --success: #22c55e;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.2), transparent 55%),
        radial-gradient(circle at bottom right, rgba(94, 234, 212, 0.18), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--text-main);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .grain {
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: 0.2;
      mix-blend-mode: soft-light;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 140 140' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n' x='-20%25' y='-20%25' width='140%25' height='140%25'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.7'/%3E%3C/svg%3E");
      z-index: -1;
    }

    .app-shell {
      max-width: 1320px;
      margin: 24px auto 40px;
      padding: 0 18px;
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
      gap: 12px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 46px;
      height: 46px;
      border-radius: 18px;
      background: radial-gradient(circle at 30% 20%, #f9fafb, #e5e7eb 40%, #0f172a 80%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 20px;
      color: #020617;
      box-shadow: 0 12px 35px rgba(15, 23, 42, 0.9);
    }

    .brand-text h1 {
      font-size: 18px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .brand-text p {
      font-size: 12px;
      color: var(--text-muted);
    }

    .chip {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(10px);
      color: var(--text-muted);
    }

    .chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--success);
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.8);
    }

    .card {
      background: var(--card-bg);
      border-radius: 20px;
      border: 1px solid var(--border);
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.9);
      padding: 22px 20px 24px;
      backdrop-filter: blur(14px);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      gap: 10px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 700;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .badge-accent {
      border-color: var(--accent-soft);
      color: var(--accent-strong);
      background: radial-gradient(circle at 0 0, var(--accent-soft), transparent 60%);
    }

    .input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-top: 8px;
    }

    .field-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 5px;
    }

    .field-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.96);
      padding: 9px 14px;
      color: var(--text-main);
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        background 0.15s ease;
    }

    .field-input:focus {
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px var(--accent-soft);
      background: rgba(15, 23, 42, 0.98);
    }

    .helper-text {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 10px;
    }

    .btn-row {
      margin-top: 18px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 9px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
      transition: transform 0.1s ease, box-shadow 0.1s ease,
        background 0.15s ease, opacity 0.15s ease;
    }

    .btn-primary {
      background: radial-gradient(circle at 30% 0%, #e0f2fe, #0ea5e9);
      color: #020617;
      box-shadow: 0 12px 35px rgba(56, 189, 248, 0.5);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(56, 189, 248, 0.6);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: rgba(15, 23, 42, 0.96);
    }

    .btn[disabled] {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* MAIN MENU */

    .menu-layout {
      display: grid;
      grid-template-columns: minmax(0, 2.7fr) minmax(0, 1.1fr);
      gap: 22px;
      margin-top: 10px;
    }

    .set-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
      gap: 16px;
      margin-top: 14px;
    }

    .set-card {
      border-radius: 20px;
      border: 1px solid var(--border);
      background: radial-gradient(circle at top left, var(--accent-soft), transparent 60%),
        rgba(15, 23, 42, 0.96);
      padding: 14px 14px 16px;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        border-color 0.12s ease, background 0.12s ease, opacity 0.12s ease;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .set-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 34px rgba(15, 23, 42, 0.9);
      border-color: var(--accent-soft);
    }

    .set-card.disabled {
      cursor: default;
      opacity: 0.35;
      box-shadow: none;
      transform: none;
      background: rgba(15, 23, 42, 0.96);
    }

    .set-label-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .set-icon {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #e0f2fe, #0ea5e9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: #020617;
      box-shadow: 0 10px 24px rgba(56, 189, 248, 0.55);
      flex-shrink: 0;
    }

    .set-name {
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      font-size: 13px;
    }

    .set-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .pill-coming {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px dashed var(--border);
      color: var(--text-muted);
      margin-left: auto;
    }

    .info-block {
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 14px 13px;
      background: radial-gradient(circle at bottom right, rgba(94, 234, 212, 0.18), transparent 60%),
        rgba(15, 23, 42, 0.96);
      font-size: 13px;
    }

    .info-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .info-list {
      margin-top: 6px;
      padding-left: 18px;
      color: var(--text-muted);
    }

    .info-list li {
      margin-bottom: 4px;
    }

    .stat-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .stat-pill {
      border-radius: 999px;
      padding: 4px 9px;
      border: 1px solid var(--border);
      font-size: 11px;
      color: var(--text-muted);
    }

    /* SET OVERVIEW */

    .set-overview-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.9fr) minmax(0, 1.3fr);
      gap: 18px;
      margin-top: 10px;
    }

    .section-block {
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.96);
      padding: 13px 12px 14px;
      font-size: 14px;
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .section-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .question-list {
      list-style: none;
      padding-left: 0;
    }

    .question-list li {
      position: relative;
      padding-left: 16px;
      margin-bottom: 6px;
    }

    .question-list li::before {
      content: "‚Ä¢";
      position: absolute;
      left: 0;
      top: 0;
      color: var(--accent-strong);
    }

    .picture-wrapper {
      margin-top: 6px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid var(--border);
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.9);
    }

    .picture-wrapper img {
      width: 100%;
      display: block;
    }

    .columns-two {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    .for-block,
    .against-block {
      border-radius: 14px;
      border: 1px dashed var(--border);
      padding: 9px 10px;
      font-size: 13px;
    }

    .for-title {
      color: var(--success);
      font-weight: 600;
      margin-bottom: 4px;
    }

    .against-title {
      color: var(--danger);
      font-weight: 600;
      margin-bottom: 4px;
    }

    .mini-list {
      padding-left: 16px;
      color: var(--text-muted);
      text-align: left;
    }

    .mini-list li {
      margin-bottom: 3px;
    }

    .overview-footer {
      margin-top: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--text-muted);
    }

    /* FULLSCREEN TEST */

    .test-card {
      margin-top: 10px;
      border-radius: 22px;
      border: 1px solid var(--border);
      background: radial-gradient(circle at top left, var(--accent-soft), transparent 60%),
        rgba(15, 23, 42, 0.96);
      min-height: calc(100vh - 120px);
      padding: 18px 18px 20px;
      display: flex;
      flex-direction: column;
    }

    .test-top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .test-title {
      font-size: 18px;
      font-weight: 600;
    }

    .test-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .progress-bar {
      height: 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(30, 64, 175, 0.7);
      overflow: hidden;
      margin-top: 6px;
    }

    .progress-inner {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, #0ea5e9, #22c55e);
      width: 0%;
      transition: width 0.3s ease;
    }

    .test-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 10px 6vw;
      gap: 16px;
    }

    .test-part-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .test-question {
      font-size: 24px;
      font-weight: 600;
    }

    .test-extra {
      font-size: 15px;
      color: var(--text-muted);
      max-width: 780px;
    }

    .test-image {
      margin-top: 8px;
      max-width: 520px;
      width: 100%;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.95);
    }

    .test-image img {
      width: 100%;
      display: block;
    }

    .timer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
      font-size: 13px;
    }

    .timer-label {
      color: var(--text-muted);
    }

    .timer-value {
      font-size: 26px;
      font-weight: 700;
      color: var(--danger);
    }

    .record-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      background: rgba(239, 68, 68, 0.14);
      color: #fecaca;
      font-size: 12px;
    }

    .record-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #f97373;
      box-shadow: 0 0 10px rgba(239, 68, 68, 0.9);
      animation: pulse 1.2s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      }
      70% {
        transform: scale(1.15);
        box-shadow: 0 0 0 7px rgba(239, 68, 68, 0);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
      }
    }

    .wave {
      display: flex;
      align-items: flex-end;
      gap: 3px;
      height: 26px;
      margin-top: 10px;
    }

    .wave-bar {
      width: 3px;
      border-radius: 999px;
      background: linear-gradient(180deg, #22c55e, #16a34a);
      transition: height 0.05s ease-out;
    }

    .test-footer {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--text-muted);
      gap: 10px;
      flex-wrap: wrap;
    }

    .completion-screen {
      margin-top: 32px;
      border-radius: 22px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      padding: 30px 24px 24px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.95);
    }

    .completion-screen h2 {
      font-size: 24px;
      color: var(--success);
      margin-bottom: 8px;
    }

    .completion-screen p {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    @media (max-width: 900px) {
      .menu-layout,
      .set-overview-layout {
        grid-template-columns: 1fr;
      }

      .test-main {
        padding-inline: 16px;
      }

      .test-question {
        font-size: 21px;
      }
    }

    @media (max-width: 600px) {
      .app-shell {
        margin-top: 16px;
      }

      .card {
        padding-inline: 14px;
      }

      .app-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="grain"></div>
  <div class="app-shell" id="app-root"></div>

  <script>
    "use strict";

    const app = document.getElementById("app-root");

    // --- CONFIG: QUESTION SETS -----------------------------------
    const speakingSets = [
      {
        id: 1,
        name: "Speaking Set 1",
        active: true,
        description: "Daily routine & school mornings",
        part1_1: [
          "What time do you usually wake up?",
          "Do you like going to the park?",
          "What do you do when you feel tired?"
        ],
        part1_2: {
          image:
            "https://i.ibb.co/pr9hGkwx/Screenshot-2025-12-03-at-00-02-09.png",
          questions: [
            "What do you see in these pictures?",
            "Why do some people like waking up early?",
            "Which do you prefer, waking up early or late, and why?"
          ]
        },
        part2: {
          main: "Describe a time when you were late for something important.",
          prompts: [
            "What happened and how did you feel?",
            "Why is being on time important?"
          ]
        },
        part3: {
          topic: "Should schools start later in the morning?",
          for: [
            "Students need more sleep to stay healthy",
            "Late classes can help improve focus",
            "It reduces morning stress and rushing"
          ],
          against: [
            "It may shorten study hours",
            "Parents might find schedules harder",
            "Students can become lazy"
          ]
        }
      },
      {
        id: 2,
        name: "Speaking Set 2",
        active: true,
        description: "Food & travelling with family",
        part1_1: [
          "Do you like playing sports?",
          "What‚Äôs your favorite food?",
          "Do you like living in a big city or a small town?"
        ],
        part1_2: {
          image:
            "https://i.ibb.co/6RBX6Y7w/Screenshot-2025-12-04-at-08-49-36.png",
          questions: [
            "What do you see in these pictures?",
            "Why do some people prefer fast food?",
            "Which food do you like more, fast food or healthy food, and why?"
          ]
        },
        part2: {
          main: "Describe a time when you went on a trip.",
          prompts: [
            "Who did you go with?",
            "Why do people like to travel?"
          ]
        },
        part3: {
          topic: "Traveling with family.",
          for: [
            "It‚Äôs fun to share experiences with family.",
            "You can make happy memories together.",
            "Traveling with family is safer."
          ],
          against: [
            "Sometimes it‚Äôs harder to plan for everyone.",
            "Not all family members enjoy the same activities.",
            "Family trips can be more expensive."
          ]
        }
      },
      {
        id: 3,
        name: "Speaking Set 3",
        active: true,
        description: "Cooking, daily life & festivals",
        part1_1: [
          "Do you like to cook?",
          "What‚Äôs your favorite time of the day?",
          "Do you enjoy spending time with your friends?"
        ],
        part1_2: {
          image:
            "https://i.ibb.co/tpvfq8Sv/Screenshot-2025-12-04-at-09-27-27.png",
          questions: [
            "What do you see in these pictures?",
            "Why do people like cooking at home?",
            "Which do you prefer, cooking at home or eating out, and why?"
          ]
        },
        part2: {
          main: "Describe a festival or celebration in your country.",
          prompts: [
            "How do people celebrate it?",
            "Why is it important?"
          ]
        },
        part3: {
          topic: "The importance of festivals.",
          for: [
            "They bring people together.",
            "Festivals are part of cultural heritage.",
            "They promote happiness and relaxation."
          ],
          against: [
            "They can be expensive.",
            "Some festivals can cause overcrowding.",
            "They may disturb normal life."
          ]
        }
      },
      {
        id: 4,
        name: "Speaking Set 4",
        active: true,
        description: "Beaches, seasons & traveling to new cities",
        part1_1: [
          "Do you like going to the beach?",
          "What‚Äôs your favorite season?",
          "Do you prefer spending time indoors or outdoors?"
        ],
        part1_2: {
          image: "https://i.ibb.co/DnxRq9M/Screenshot-2025-12-04-at-12-35-08.png",
          questions: [
            "What do you see in these pictures?",
            "Why do people like visiting the beach?",
            "Which place would you prefer to visit, the beach or the mountains, and why?"
          ]
        },
        part2: {
          main: "Describe a time you visited a new city.",
          prompts: [
            "What did you do there?",
            "What did you enjoy most about the trip?"
          ]
        },
        part3: {
          topic: "Traveling to new cities.",
          for: [
            "You can experience new cultures.",
            "It‚Äôs a chance to meet new people.",
            "Traveling can be educational."
          ],
          against: [
            "It can be expensive.",
            "Traveling may cause stress.",
            "Some places may feel overcrowded."
          ]
        }
      },
      // Coming soon sets 5‚Äì10
      ...Array.from({ length: 6 }).map((_, i) => ({
        id: i + 5,
        name: `Speaking Set ${i + 5}`,
        active: false,
        comingSoon: true,
        description: "Coming soon"
      }))
    ];

    // --- STATE ---------------------------------------------------
    const now = new Date();

    const state = {
      page: "login", // login | menu | overview | test | done
      student: {
        firstName: "",
        surname: "",
        group: "",
        date: now.toLocaleDateString("en-GB"),
        time: now.toLocaleTimeString("en-GB", {
          hour: "2-digit",
          minute: "2-digit"
        })
      },
      selectedSet: null,
      test: {
        part: null,     // "p11" | "p12" | "p2" | "p3"
        questionIndex: 0,
        phase: null,    // "prestart" | "read" | "speak" | "prep" | "transition"
        secondsLeft: 0,
        transitionTo: null // "p12" | "p2" | "p3" when in transition
      },
      timerId: null,

      // audio / recording
      stream: null,
      audioContext: null,
      analyser: null,
      waveBars: Array.from({ length: 20 }, () => 5),

      // recording per part
      mediaRecorder: null,
      recordingPartKey: null, // "part1" | "part2" | "part3" | null
      partChunks: {
        part1: [],
        part2: [],
        part3: []
      },
      partBlobs: {
        part1: null,
        part2: null,
        part3: null
      },
      partSent: {
        part1: false,
        part2: false,
        part3: false
      },
      isMicActive: false // for visualizer only
    };

    // --- HELPERS -------------------------------------------------
    function logicalPartKey(partCode) {
      if (partCode === "p11" || partCode === "p12") return "part1";
      if (partCode === "p2") return "part2";
      if (partCode === "p3") return "part3";
      return null;
    }

    function logicalPartLabel(key) {
      if (key === "part1") return "Part 1";
      if (key === "part2") return "Part 2";
      if (key === "part3") return "Part 3";
      return key;
    }

    // --- RENDER ROOT ---------------------------------------------
    function render() {
      if (state.page === "login") {
        renderLogin();
      } else if (state.page === "menu") {
        renderMenu();
      } else if (state.page === "overview") {
        renderOverview();
      } else if (state.page === "test") {
        renderTest();
      } else if (state.page === "done") {
        renderDone();
      }
    }

    // --- LOGIN ---------------------------------------------------
    function renderLogin() {
      app.innerHTML = `
        <header class="app-header">
          <div class="brand">
            <div class="brand-logo">S</div>
            <div class="brand-text">
              <h1>CEFR Speaking Lab</h1>
              <p>Teacher receives your recording on Telegram</p>
            </div>
          </div>
          <div class="chip">
            <span class="chip-dot"></span>
            Student login
          </div>
        </header>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Log in to start speaking</div>
              <div class="card-subtitle">
                Enter your details exactly. They are sent with your recording.
              </div>
            </div>
            <span class="badge badge-accent">Step 1</span>
          </div>

          <div class="input-grid">
            <div>
              <div class="field-label">First name</div>
              <input id="firstName" class="field-input" placeholder="e.g. Doniyor" value="${state.student.firstName}">
            </div>
            <div>
              <div class="field-label">Surname</div>
              <input id="surname" class="field-input" placeholder="e.g. Eshmurodov" value="${state.student.surname}">
            </div>
            <div>
              <div class="field-label">Group</div>
              <input id="group" class="field-input" placeholder="e.g. CEFR B1 ‚Äì Everest" value="${state.student.group}">
            </div>
          </div>

          <p class="helper-text">
            Example: <strong>CEFR B1 ‚Äì Evening</strong>, <strong>IELTS Intro ‚Äì 17:00</strong>, etc.
          </p>

          <div class="btn-row">
            <button class="btn btn-primary" onclick="handleLogin()">Continue to menu ‚Üí</button>
          </div>
        </section>
      `;
    }

    function handleLogin() {
      const firstName = document.getElementById("firstName").value.trim();
      const surname = document.getElementById("surname").value.trim();
      const group = document.getElementById("group").value.trim();

      if (!firstName || !surname || !group) {
        alert("Please fill in your first name, surname and group.");
        return;
      }

      const now = new Date();
      state.student.firstName = firstName;
      state.student.surname = surname;
      state.student.group = group;
      state.student.date = now.toLocaleDateString("en-GB");
      state.student.time = now.toLocaleTimeString("en-GB", {
        hour: "2-digit",
        minute: "2-digit"
      });

      state.page = "menu";
      render();
    }

    // --- MENU ----------------------------------------------------
    function renderMenu() {
      const activeCount = speakingSets.filter((s) => s.active).length;

      app.innerHTML = `
        <header class="app-header">
          <div class="brand">
            <div class="brand-logo">S</div>
            <div class="brand-text">
              <h1>Main Menu</h1>
              <p>${state.student.firstName || "Student"} ${
        state.student.surname || ""
      } ¬∑ ${state.student.group || "Group"}</p>
            </div>
          </div>
          <div class="chip">
            <span class="chip-dot"></span>
            ${activeCount} active set${activeCount !== 1 ? "s" : ""}
          </div>
        </header>

        <section class="menu-layout">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Choose your speaking set</div>
                <div class="card-subtitle">
                  Sets 1, 2, 3 and 4 are active now. Other sets are coming soon.
                </div>
              </div>
              <span class="badge">10 sets</span>
            </div>

            <div class="set-grid">
              ${speakingSets
                .map((set) => {
                  if (!set.active) {
                    return `
                      <div class="set-card disabled">
                        <div class="set-label-row">
                          <div class="set-icon">${set.id}</div>
                          <div>
                            <div class="set-name">${set.name}</div>
                            <div class="set-meta">${set.description}</div>
                          </div>
                          <span class="pill-coming">Coming soon</span>
                        </div>
                      </div>
                    `;
                  }
                  return `
                    <div class="set-card" onclick="openSet(${set.id})">
                      <div class="set-label-row">
                        <div class="set-icon">${set.id}</div>
                        <div>
                          <div class="set-name">${set.name}</div>
                          <div class="set-meta">${set.description}</div>
                        </div>
                      </div>
                    </div>
                  `;
                })
                .join("")}
            </div>
          </div>

          <aside class="info-block">
            <div class="info-title">How this test works</div>
            <ul class="info-list">
              <li>First you see all questions and the picture.</li>
              <li>Then you click <strong>Start speaking</strong>.</li>
              <li>You see one question at a time in full screen.</li>
              <li>Reading / preparation and speaking time are automatic.</li>
              <li><strong>Recording is only ON during speaking time</strong>.</li>
              <li>Between parts you see a 4-second screen like ‚ÄúLet‚Äôs move to Part 2‚Äù.</li>
              <li>Your voice for Part 1, Part 2 and Part 3 is sent separately to your teacher on Telegram.</li>
            </ul>

            <div class="stat-row">
              <div class="stat-pill">üìÖ ${state.student.date}</div>
              <div class="stat-pill">‚è∞ ${state.student.time}</div>
              <div class="stat-pill">üë§ ${state.student.firstName} ${
        state.student.surname
      }</div>
              <div class="stat-pill">üë• ${state.student.group}</div>
            </div>
          </aside>
        </section>
      `;
    }

    function openSet(id) {
      const set = speakingSets.find((s) => s.id === id);
      if (!set || !set.active) return;
      state.selectedSet = set;
      state.page = "overview";
      render();
    }

    // --- SET OVERVIEW --------------------------------------------
    function renderOverview() {
      const set = state.selectedSet;
      if (!set) {
        state.page = "menu";
        render();
        return;
      }

      app.innerHTML = `
        <header class="app-header">
          <div class="brand">
            <div class="brand-logo">S</div>
            <div class="brand-text">
              <h1>${set.name}</h1>
              <p>${state.student.firstName} ${state.student.surname} ¬∑ ${
        state.student.group
      }</p>
            </div>
          </div>
          <div class="btn-row" style="margin-top:0;">
            <button class="btn btn-secondary" onclick="backToMenu()">‚Üê Back</button>
            <button class="btn btn-primary" onclick="startTestFromOverview()">Start speaking üéôÔ∏è</button>
          </div>
        </header>

        <section class="set-overview-layout">
          <div class="section-block">
            <div class="section-title">Part 1.1 ‚Äì Short questions</div>
            <div class="section-sub">
              You will answer each question one by one. First you have 5 seconds to read, then 30 seconds to answer.
            </div>
            <ul class="question-list">
              ${set.part1_1.map((q, i) => `<li>${i + 1}. ${q}</li>`).join("")}
            </ul>

            <div style="margin-top:12px; border-top:1px dashed var(--border); padding-top:10px;">
              <div class="section-title">Part 1.2 ‚Äì Picture questions</div>
              <div class="section-sub">
                You have 5 seconds to read each question. For question 1 you get 45 seconds to answer, for questions 2 and 3 you get 30 seconds.
              </div>
              <div class="picture-wrapper">
                <img src="${set.part1_2.image}" alt="Part 1.2 picture">
              </div>
              <ul class="question-list" style="margin-top:8px;">
                ${set.part1_2.questions
                  .map((q, i) => `<li>${i + 1}. ${q}</li>`)
                  .join("")}
              </ul>
            </div>
          </div>

          <div class="section-block">
            <div class="section-title">Part 2 ‚Äì Long turn</div>
            <div class="section-sub">
              You will have 1 minute to prepare and 2 minutes to speak.
            </div>
            <p><strong>${set.part2.main}</strong></p>
            <ul class="question-list" style="margin-top:6px;">
              ${set.part2.prompts.map((p) => `<li>${p}</li>`).join("")}
            </ul>

            <div style="margin-top:14px; border-top:1px dashed var(--border); padding-top:10px;">
              <div class="section-title">Part 3 ‚Äì Discussion</div>
              <div class="section-sub">
                Topic: <strong>${set.part3.topic}</strong><br>
                1 minute to prepare and 2 minutes to discuss.
              </div>
              <div class="columns-two">
                <div class="for-block">
                  <div class="for-title">FOR</div>
                  <ul class="mini-list">
                    ${set.part3.for.map((p) => `<li>${p}</li>`).join("")}
                  </ul>
                </div>
                <div class="against-block">
                  <div class="against-title">AGAINST</div>
                  <ul class="mini-list">
                    ${set.part3.against.map((p) => `<li>${p}</li>`).join("")}
                  </ul>
                </div>
              </div>
            </div>

            <div class="overview-footer">
              <span>
                After you click <strong>Start speaking</strong>, you will see a warning:
                <strong>"The test will start in 3 seconds"</strong>.
              </span>
              <span>Then parts run automatically: 1.1 ‚Üí 1.2 ‚Üí 2 ‚Üí 3, with a 4-second screen between parts.</span>
            </div>
          </div>
        </section>
      `;
    }

    function backToMenu() {
      state.selectedSet = null;
      state.page = "menu";
      render();
    }

    // --- TEST FLOW & TIMERS -------------------------------------
    function startTestFromOverview() {
      if (!state.selectedSet) return;
      startMicAndTest();
    }

    async function startMicAndTest() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Your browser does not support microphone recording. Please use the latest Chrome or Edge.");
        return;
      }

      if (typeof MediaRecorder === "undefined") {
        alert("MediaRecorder is not supported in this browser. Please use the latest Chrome or Edge.");
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        state.stream = stream;

        // reset part recordings
        state.partChunks = { part1: [], part2: [], part3: [] };
        state.partBlobs = { part1: null, part2: null, part3: null };
        state.partSent = { part1: false, part2: false, part3: false };
        state.mediaRecorder = null;
        state.recordingPartKey = null;

        // visualizer
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        state.audioContext = new AudioCtx();
        const source = state.audioContext.createMediaStreamSource(stream);
        state.analyser = state.audioContext.createAnalyser();
        state.analyser.fftSize = 256;
        source.connect(state.analyser);
        state.isMicActive = true;
        startVisualizer();

        // test initial state with 3-second warning
        state.test.part = "p11";
        state.test.questionIndex = 0;
        state.test.phase = "prestart"; // warning: test starts in 3 seconds
        state.test.secondsLeft = 3;
        state.test.transitionTo = null;

        state.page = "test";
        render();
        startTimer();
      } catch (err) {
        console.error("getUserMedia error:", err);
        alert("Could not access your microphone. Please allow microphone access and try again.");
      }
    }

    function startVisualizer() {
      if (!state.analyser) return;

      const bufferLength = state.analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);

      function draw() {
        if (!state.analyser || !state.isMicActive) return;
        state.analyser.getByteFrequencyData(dataArray);

        state.waveBars = state.waveBars.map((_, index) => {
          const idx = Math.floor(index * (bufferLength / state.waveBars.length));
          const value = dataArray[idx] / 255;
          return Math.max(5, Math.floor(value * 26));
        });

        const el = document.getElementById("wave");
        if (el) {
          el.innerHTML = state.waveBars
            .map((h) => `<div class="wave-bar" style="height:${h}px"></div>`)
            .join("");
        }

        requestAnimationFrame(draw);
      }

      draw();
    }

    function startTimer() {
      clearInterval(state.timerId);
      state.timerId = setInterval(() => {
        if (state.test.secondsLeft > 0) {
          state.test.secondsLeft -= 1;
          render();
        } else {
          advanceTestState();
        }
      }, 1000);
    }

    function stopCurrentSegmentRecording() {
      if (state.mediaRecorder && state.mediaRecorder.state === "recording") {
        try {
          state.mediaRecorder.stop();
        } catch (e) {
          console.error("Error stopping mediaRecorder:", e);
        }
      }
      state.mediaRecorder = null;
      state.recordingPartKey = null;
    }

    // Build the final blob for a part and (optionally) send it now
    function finalizePartRecording(partKey, sendNow = false) {
      const chunks = state.partChunks[partKey];
      if (!chunks || chunks.length === 0) return;

      if (!state.partBlobs[partKey]) {
        const type = chunks[0].type || "audio/webm";
        state.partBlobs[partKey] = new Blob(chunks, { type });
      }

      if (sendNow && !state.partSent[partKey]) {
        state.partSent[partKey] = true;
        // fire and forget
        sendSinglePartToTelegram(partKey);
      }
    }

    function startSegmentRecordingIfNeeded() {
      if (!state.stream) return;
      if (state.test.phase !== "speak") return;

      const partKey = logicalPartKey(state.test.part);
      if (!partKey) return;

      let options = {};
      if (MediaRecorder.isTypeSupported("audio/webm;codecs=opus")) {
        options.mimeType = "audio/webm;codecs=opus";
      } else if (MediaRecorder.isTypeSupported("audio/webm")) {
        options.mimeType = "audio/webm";
      }

      const mr = new MediaRecorder(state.stream, options);
      state.mediaRecorder = mr;
      state.recordingPartKey = partKey;

      mr.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) {
          state.partChunks[partKey].push(e.data);
        }
      };

      mr.onerror = (e) => {
        console.error("MediaRecorder error:", e.error || e);
      };

      mr.start(1000); // push chunks every second
    }

    function advanceTestState() {
      const set = state.selectedSet;
      const t = state.test;
      if (!set) return;

      // STOP recording if we are leaving a speaking segment
      if (t.phase === "speak") {
        stopCurrentSegmentRecording();
      }

      // Handle 4-second transitions between parts
      if (t.phase === "transition") {
        const target = t.transitionTo;
        t.transitionTo = null;

        if (target === "p12") {
          t.part = "p12";
          t.questionIndex = 0;
          t.phase = "read";
          t.secondsLeft = 5;
        } else if (target === "p2") {
          t.part = "p2";
          t.questionIndex = 0;
          t.phase = "prep";
          t.secondsLeft = 60;
        } else if (target === "p3") {
          t.part = "p3";
          t.questionIndex = 0;
          t.phase = "prep";
          t.secondsLeft = 60;
        } else {
          // fallback
          finishTest();
          return;
        }

        render();
        startTimer();
        if (state.test.phase === "speak") {
          startSegmentRecordingIfNeeded();
        }
        return;
      }

      if (t.part === "p11") {
        if (t.phase === "prestart") {
          // after 3s warning ‚Üí first reading
          t.phase = "read";
          t.secondsLeft = 5;
        } else if (t.phase === "read") {
          t.phase = "speak";
          t.secondsLeft = 30;
        } else {
          // after speaking
          if (t.questionIndex < set.part1_1.length - 1) {
            t.questionIndex += 1;
            t.phase = "read";
            t.secondsLeft = 5;
          } else {
            // after last Part 1.1 question ‚Üí 4-second interval before Part 1.2
            t.phase = "transition";
            t.transitionTo = "p12";
            t.secondsLeft = 4;
          }
        }
      } else if (t.part === "p12") {
        if (t.phase === "read") {
          t.phase = "speak";
          t.secondsLeft = t.questionIndex === 0 ? 45 : 30;
        } else {
          if (t.questionIndex < set.part1_2.questions.length - 1) {
            t.questionIndex += 1;
            t.phase = "read";
            t.secondsLeft = 5;
          } else {
            // after last Part 1.2 question ‚Üí 4-second interval before Part 2
            t.phase = "transition";
            t.transitionTo = "p2";
            t.secondsLeft = 4;

            // Part 1 finished ‚Üí send immediately
            finalizePartRecording("part1", true);
          }
        }
      } else if (t.part === "p2") {
        if (t.phase === "prep") {
          t.phase = "speak";
          t.secondsLeft = 120;
        } else {
          // after speaking Part 2 ‚Üí 4-second interval before Part 3
          t.phase = "transition";
          t.transitionTo = "p3";
          t.secondsLeft = 4;

          // Part 2 finished ‚Üí send immediately
          finalizePartRecording("part2", true);
        }
      } else if (t.part === "p3") {
        if (t.phase === "prep") {
          t.phase = "speak";
          t.secondsLeft = 120;
        } else {
          // Part 3 finished ‚Üí send immediately, then finish test
          finalizePartRecording("part3", true);
          finishTest();
          return;
        }
      }

      render();
      startTimer();

      // START recording if we entered a speaking segment
      if (state.test.phase === "speak") {
        startSegmentRecordingIfNeeded();
      }
    }

    // --- TEST RENDER ---------------------------------------------
    function renderTest() {
      const set = state.selectedSet;
      const t = state.test;
      if (!set) {
        state.page = "menu";
        render();
        return;
      }

      const { title, subtitle, questionText, extraHtml, showImage, progress } =
        buildTestView(set, t);

      app.innerHTML = `
        <header class="app-header">
          <div class="brand">
            <div class="brand-logo">S</div>
            <div class="brand-text">
              <h1>${set.name}</h1>
              <p>${state.student.firstName} ${state.student.surname} ¬∑ ${
        state.student.group
      }</p>
            </div>
          </div>
          <button class="btn btn-secondary" onclick="finishTest()">Finish now</button>
        </header>

        <section class="test-card">
          <div class="test-top-row">
            <div>
              <div class="test-title">${title}</div>
              <div class="test-subtitle">${subtitle}</div>
              <div class="progress-bar">
                <div class="progress-inner" style="width:${progress}%"></div>
              </div>
            </div>
            <div class="record-indicator">
              <span class="record-dot"></span>
              <span>${
                state.test.phase === "speak"
                  ? "Recording (speaking time)"
                  : "Mic on, recording off"
              }</span>
            </div>
          </div>

          <div class="test-main">
            <div class="test-part-label">${phaseLabel(t)}</div>
            <div class="test-question">${questionText}</div>
            ${
              extraHtml
                ? `<div class="test-extra">${extraHtml}</div>`
                : ""
            }
            ${
              showImage
                ? `<div class="test-image"><img src="${set.part1_2.image}" alt="Picture for Part 1.2"></div>`
                : ""
            }
          </div>

          <div class="timer-row">
            <div>
              <div class="timer-label">${timerLabel(t)}</div>
              <div class="timer-value">${formatTime(t.secondsLeft)}</div>
            </div>
            <div id="wave" class="wave">
              ${state.waveBars
                .map((h) => `<div class="wave-bar" style="height:${h}px"></div>`)
                .join("")}
            </div>
          </div>

          <div class="test-footer">
            <span>Test runs automatically. Just watch the timer and keep speaking.</span>
            <span>Current part: ${simplePartName(t.part)}</span>
          </div>
        </section>
      `;
    }

    function buildTestView(set, t) {
      let title = "";
      let subtitle = "";
      let questionText = "";
      let extraHtml = "";
      let showImage = false;

      const len1 = set.part1_1.length;
      const len2 = set.part1_2.questions.length;

      // total steps: prestart + p11(q) + transition1 + p12(q) + transition2 + p2(2) + transition3 + p3(2)
      const totalSteps = 1 + len1 + 1 + len2 + 1 + 2 + 1 + 2; // = len1 + len2 + 8

      let currentStepIndex = 0;

      // map to index
      if (t.part === "p11" && t.phase === "prestart") {
        currentStepIndex = 0;
      } else if (t.phase === "transition" && t.transitionTo === "p12") {
        currentStepIndex = 1 + len1; // after all p11 questions
      } else if (t.phase === "transition" && t.transitionTo === "p2") {
        currentStepIndex = 1 + len1 + 1 + len2; // after all p12 questions
      } else if (t.phase === "transition" && t.transitionTo === "p3") {
        currentStepIndex = 1 + len1 + 1 + len2 + 2; // after p2 prep+speaking
      } else if (t.part === "p11") {
        // reading or speaking questions
        currentStepIndex = 1 + t.questionIndex;
      } else if (t.part === "p12") {
        currentStepIndex = 1 + len1 + 1 + t.questionIndex;
      } else if (t.part === "p2") {
        const base = 1 + len1 + 1 + len2 + 1; // first p2 step
        currentStepIndex =
          t.phase === "prep" ? base : base + 1;
      } else if (t.part === "p3") {
        const base = 1 + len1 + 1 + len2 + 1 + 2 + 1; // first p3 step
        currentStepIndex =
          t.phase === "prep" ? base : base + 1;
      }

      const progress = Math.min(
        100,
        ((currentStepIndex + 1) / totalSteps) * 100
      );

      // Transition screens between parts
      if (t.phase === "transition") {
        let moveText = "Let's move to the next part.";
        if (t.transitionTo === "p12") {
          title = "Moving to Part 1.2";
          subtitle = "Picture questions are coming.";
          moveText = "Let's move to Part 1.2 ‚Äì picture questions.";
        } else if (t.transitionTo === "p2") {
          title = "Moving to Part 2";
          subtitle = "You will have 1 minute to prepare.";
          moveText = "Let's move to Part 2 ‚Äì long turn.";
        } else if (t.transitionTo === "p3") {
          title = "Moving to Part 3";
          subtitle = "You will discuss both sides of a topic.";
          moveText = "Let's move to Part 3 ‚Äì discussion questions.";
        } else {
          title = "Moving to next part";
          subtitle = "The next part will start in a few seconds.";
        }

        questionText = moveText;
        return { title, subtitle, questionText, extraHtml, showImage, progress };
      }

      if (t.part === "p11" && t.phase === "prestart") {
        title = "Get ready";
        subtitle = "The speaking test will start in a few seconds.";
        questionText = "The test will start in 3 seconds. Please get ready.";
      } else if (t.part === "p11") {
        title = "Part 1.1 ‚Äì Short questions";
        subtitle = "5 seconds to read, 30 seconds to answer each question.";
        questionText = set.part1_1[t.questionIndex];
      } else if (t.part === "p12") {
        title = "Part 1.2 ‚Äì Picture questions";
        subtitle =
          "Look at the picture. 5 seconds to read, then answer the question.";
        questionText = set.part1_2.questions[t.questionIndex];
        showImage = true;
      } else if (t.part === "p2") {
        title = "Part 2 ‚Äì Long turn";
        subtitle =
          "You have 1 minute to prepare and then 2 minutes to speak.";
        questionText = set.part2.main;

        const promptsHtml = `
          <ul class="mini-list">
            ${set.part2.prompts.map((p) => `<li>${p}</li>`).join("")}
          </ul>
        `;

        if (t.phase === "prep") {
          extraHtml = `
            <p>Use the points below to plan your answer:</p>
            ${promptsHtml}
          `;
        } else {
          extraHtml = `
            <p>While you speak, try to cover these points:</p>
            ${promptsHtml}
          `;
        }
      } else if (t.part === "p3") {
        title = "Part 3 ‚Äì Discussion";
        subtitle =
          "1 minute to prepare ideas, then 2 minutes to discuss both sides.";
        questionText = set.part3.topic;

        const forAgainstHtml = `
          <div class="columns-two">
            <div class="for-block">
              <div class="for-title">FOR</div>
              <ul class="mini-list">
                ${set.part3.for.map((p) => `<li>${p}</li>`).join("")}
              </ul>
            </div>
            <div class="against-block">
              <div class="against-title">AGAINST</div>
              <ul class="mini-list">
                ${set.part3.against.map((p) => `<li>${p}</li>`).join("")}
              </ul>
            </div>
          </div>
        `;

        if (t.phase === "prep") {
          extraHtml = `
            <p>Look at the arguments for and against. Decide which side you agree with and plan your reasons.</p>
            ${forAgainstHtml}
          `;
        } else {
          extraHtml = `
            <p>Use these points while speaking. Explain both sides and then give your own opinion.</p>
            ${forAgainstHtml}
          `;
        }
      }

      return { title, subtitle, questionText, extraHtml, showImage, progress };
    }

    function phaseLabel(t) {
      if (t.part === "p11" && t.phase === "prestart") {
        return "Get ready";
      }
      if (t.phase === "transition") {
        return "Moving to next part";
      }
      if (t.part === "p2" || t.part === "p3") {
        return t.phase === "prep" ? "Preparation time" : "Speaking time";
      }
      if (t.phase === "read") return "Reading the question";
      if (t.phase === "speak") return "Speaking";
      return "";
    }

    function timerLabel(t) {
      if (t.part === "p11" && t.phase === "prestart") {
        return "Test starts in";
      }
      if (t.phase === "transition") {
        return "Next part starts in";
      }
      if (t.part === "p2" || t.part === "p3") {
        return t.phase === "prep" ? "Preparation time" : "Speaking time";
      }
      return t.phase === "read" ? "Reading time" : "Speaking time";
    }

    function simplePartName(part) {
      if (part === "p11" || part === "p12") return "Part 1";
      if (part === "p2") return "Part 2";
      if (part === "p3") return "Part 3";
      return "";
    }

    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${m}:${s.toString().padStart(2, "0")}`;
    }

    // --- COMPLETION ----------------------------------------------
    function renderDone() {
      const hasP1 = !!state.partBlobs.part1;
      const hasP2 = !!state.partBlobs.part2;
      const hasP3 = !!state.partBlobs.part3;

      app.innerHTML = `
        <header class="app-header">
          <div class="brand">
            <div class="brand-logo">S</div>
            <div class="brand-text">
              <h1>Speaking test finished</h1>
              <p>${state.student.firstName} ${state.student.surname} ¬∑ ${
        state.student.group
      }</p>
            </div>
          </div>
        </header>

        <section class="completion-screen">
          <h2>‚úÖ Great job!</h2>
          <p>
            Your test is complete. Separate recordings for Part 1, Part 2 and Part 3
            are being sent to your teacher on Telegram.
            You can also download them for your own practice.
          </p>
          <div class="btn-row" style="justify-content:center; flex-wrap:wrap;">
            ${
              hasP1
                ? `<button class="btn btn-primary" onclick="downloadRecording('part1')">Download Part 1</button>`
                : ""
            }
            ${
              hasP2
                ? `<button class="btn btn-primary" onclick="downloadRecording('part2')">Download Part 2</button>`
                : ""
            }
            ${
              hasP3
                ? `<button class="btn btn-primary" onclick="downloadRecording('part3')">Download Part 3</button>`
                : ""
            }
            <button class="btn btn-secondary" onclick="backToMenuAfterDone()">Back to main menu</button>
          </div>
        </section>
      `;
    }

    function backToMenuAfterDone() {
      state.page = "menu";
      render();
    }

    function downloadRecording(partKey) {
      const blob = state.partBlobs[partKey];
      if (!blob) {
        alert("No recording file found for this part.");
        return;
      }
      const setId = state.selectedSet ? state.selectedSet.id : 1;
      const safeDate = state.student.date.replace(/\//g, "-");
      const safeTime = state.student.time.replace(/:/g, "-");
      const label = logicalPartLabel(partKey).replace(/\s+/g, "");
      const fileName = `${state.student.firstName}_${state.student.surname}_${state.student.group}_Set${setId}_${label}_${safeDate}_${safeTime}.webm`;

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // --- TELEGRAM API CALL ---------------------------------------
    async function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const result = reader.result || "";
          const base64 =
            typeof result === "string" && result.includes(",")
              ? result.split(",")[1]
              : result;
          resolve(base64);
        };
        reader.onerror = () =>
          reject(reader.error || new Error("Failed to read audio"));
        reader.readAsDataURL(blob);
      });
    }

    async function sendSinglePartToTelegram(partKey) {
      const blob = state.partBlobs[partKey];
      if (!blob || !state.selectedSet) return;
      const partLabel = logicalPartLabel(partKey);
      try {
        const base64Audio = await blobToBase64(blob);

        const res = await fetch("/api/sendRecording", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            firstName: state.student.firstName,
            surname: state.student.surname,
            group: state.student.group,
            setName: state.selectedSet.name,
            date: state.student.date,
            time: state.student.time,
            part: partLabel,
            audioBase64: base64Audio
          })
        });

        let data = {};
        try {
          data = await res.json();
        } catch (_) {}

        if (!res.ok || data.ok === false) {
          console.error("Telegram error for", partLabel, data);
        }
      } catch (err) {
        console.error("sendToTelegram error for part", partKey, err);
      }
    }

    async function sendToTelegram() {
      // send only parts that have a blob and were not sent yet
      const parts = ["part1", "part2", "part3"];
      for (const key of parts) {
        if (state.partBlobs[key] && !state.partSent[key]) {
          state.partSent[key] = true;
          await sendSinglePartToTelegram(key);
        }
      }
    }

    async function finishTest() {
      clearInterval(state.timerId);

      // stop any current segment recording
      stopCurrentSegmentRecording();

      if (state.audioContext) {
        try {
          await state.audioContext.close();
        } catch (_) {}
        state.audioContext = null;
        state.analyser = null;
        state.isMicActive = false;
      }

      if (state.stream) {
        state.stream.getTracks().forEach((t) => t.stop());
        state.stream = null;
      }

      // Build blobs for each part (if not already built)
      ["part1", "part2", "part3"].forEach((key) => {
        finalizePartRecording(key, false);
      });

      state.page = "done";
      render();
      // Send any parts that haven't been sent yet
      sendToTelegram();
    }

    // --- GLOBALS FOR INLINE HANDLERS -----------------------------
    window.handleLogin = handleLogin;
    window.openSet = openSet;
    window.backToMenu = backToMenu;
    window.startTestFromOverview = startTestFromOverview;
    window.finishTest = finishTest;
    window.downloadRecording = downloadRecording;
    window.backToMenuAfterDone = backToMenuAfterDone;

    // initial render
    render();
  </script>
</body>
</html>
