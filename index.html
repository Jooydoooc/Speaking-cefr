<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CEFR Speaking ‚Äì Multilevel</title>

<style>
/* -------------------- GLOBAL STYLE -------------------- */
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg1: #020617;
  --bg2: #0f172a;
  --accent: #38bdf8;
  --accent-strong: #0ea5e9;
  --accent-soft: rgba(56, 189, 248, 0.2);
  --text-main: #e5e7eb;
  --text-muted: #9ca3af;
  --card-bg: rgba(15, 23, 42, 0.96);
  --border: rgba(148, 163, 184, 0.4);
  --danger: #ef4444;
  --success: #22c55e;
}

body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background:
    radial-gradient(circle at top left, rgba(56,189,248,.2), transparent 55%),
    radial-gradient(circle at bottom right, rgba(94,234,212,.18), transparent 55%),
    linear-gradient(135deg, var(--bg1), var(--bg2));
  color: var(--text-main);
  min-height: 100vh;
  overflow-x: hidden;
}

/* Floating grain */
.grain {
  position: fixed; inset: 0; pointer-events: none;
  opacity: 0.2; mix-blend-mode: soft-light;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 140 140' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n' x='-20%25' y='-20%25' width='140%25' height='140%25'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.7'/%3E%3C/svg%3E");
  z-index: -1;
}

.app-shell { max-width: 1320px; margin: 24px auto 40px; padding: 0 18px; }

/* Headers */
.app-header {
  display: flex; justify-content: space-between;
  align-items: center; margin-bottom: 18px; gap: 12px;
}

.brand { display: flex; align-items: center; gap: 10px; }
.brand-logo {
  width: 46px; height: 46px; border-radius: 18px;
  background: radial-gradient(circle at 30% 20%, #f9fafb, #e5e7eb 40%, #0f172a 80%);
  display: flex; justify-content: center; align-items: center;
  font-weight: 800; font-size: 20px; color: #020617;
  box-shadow: 0 12px 35px rgba(15,23,42,0.9);
}
.brand-text h1 { font-size: 18px; letter-spacing: .08em; text-transform: uppercase; }
.brand-text p { font-size: 12px; color: var(--text-muted); }

/* Card */
.card {
  background: var(--card-bg);
  border-radius: 20px;
  border: 1px solid var(--border);
  box-shadow: 0 20px 60px rgba(15,23,42,0.9);
  padding: 22px 20px 24px;
  backdrop-filter: blur(14px);
}

/* Input areas */
.input-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
  gap: 14px;
  margin-top: 8px;
}
.field-label {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: .06em;
  color: var(--text-muted);
  margin-bottom: 5px;
}
.field-input {
  width: 100%;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: rgba(15,23,42,.96);
  padding: 9px 14px;
  color: var(--text-main);
  font-size: 14px;
  outline: none;
}
.field-input:focus {
  border-color: var(--accent-strong);
  box-shadow: 0 0 0 1px var(--accent-soft);
}

.btn {
  padding: 10px 20px; border-radius: 999px; border: none;
  font-size: 14px; font-weight: 600; cursor: pointer;
  transition: .12s ease;
}
.btn-primary {
  background: linear-gradient(135deg, #22c55e, #a3e635);
  color: #022c22;
}
.btn-secondary {
  background: rgba(255,255,255,.05);
  border: 1px solid var(--border);
  color: var(--text-main);
}

/* Main menu cards */
.set-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(210px,1fr));
  gap: 16px; margin-top: 14px;
}
.set-card {
  border-radius: 20px; padding: 14px 14px 16px;
  background: radial-gradient(circle at top left, var(--accent-soft), transparent 60%), rgba(15,23,42,.96);
  border: 1px solid var(--border);
  cursor: pointer;
  transition: .12s ease;
}
.set-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 16px 34px rgba(15,23,42,.9);
}

/* Test fullscreen card */
.test-card {
  margin-top: 10px;
  border-radius: 22px;
  border: 1px solid var(--border);
  background: radial-gradient(circle at top left, var(--accent-soft), transparent 60%), rgba(15,23,42,.96);
  min-height: calc(100vh - 120px);
  padding: 18px 18px 20px;
  display: flex;
  flex-direction: column;
}

/* Visualizer bars */
.wave {
  display: flex; align-items: flex-end; gap: 3px;
  height: 26px; margin-top: 10px;
}
.wave-bar {
  width: 3px; border-radius: 999px;
  background: linear-gradient(180deg, #22c55e, #16a34a);
}

/* Completion */
.completion-screen {
  margin-top: 32px;
  border-radius: 22px;
  border: 1px solid var(--border);
  background: var(--card-bg);
  padding: 30px 24px 24px;
  text-align: center;
}

</style>
</head>
<body>

<div class="grain"></div>
<div class="app-shell" id="app-root"></div>

<script>
/*  ============================================================
     FULL JAVASCRIPT LOGIC
     Contains:
     - Page navigation
     - Speaking sets
     - Recording
     - Timers
     - 4-second transitions
     - Telegram upload
    ============================================================ */

const app = document.getElementById("app-root");

/* ---------------------- SPEAKING SET ---------------------- */
const speakingSets = [
  {
    id: 1,
    name: "Speaking Set 1",
    active: true,
    description: "Daily routine & school mornings",
    part1_1: [
      "What time do you usually wake up?",
      "Do you like going to the park?",
      "What do you do when you feel tired?"
    ],
    part1_2: {
      image: "https://i.ibb.co/pr9hGkwx/Screenshot-2025-12-03-at-00-02-09.png",
      questions: [
        "What do you see in these pictures?",
        "Why do some people like waking up early?",
        "Which do you prefer, waking up early or late, and why?"
      ]
    },
    part2: {
      main: "Talk about a time when you were late for something important.",
      prompts: [
        "What happened and how did you feel?",
        "Why is being on time important?"
      ]
    },
    part3: {
      topic: "Should schools start later in the morning?",
      for: [
        "Students need more sleep to stay healthy",
        "Late classes can help improve focus",
        "It reduces morning stress and rushing"
      ],
      against: [
        "It may shorten study hours",
        "Parents might find schedules harder",
        "Students can become lazy"
      ]
    }
  }
];

/* ---------------------- STATE ---------------------- */
const state = {
  page: "login",
  student: {
    firstName: "",
    surname: "",
    group: ""
  },
  selectedSet: null,
  test: {
    part: null,
    phase: null,
    questionIndex: 0,
    secondsLeft: 0,
    transitionTo: null
  },
  timerId: null,
  isRecording: false,
  mediaRecorder: null,
  audioChunks: [],
  audioBlob: null
};

/* ---------------------- RENDER ---------------------- */
function render() {
  if (state.page === "login") return renderLogin();
  if (state.page === "menu") return renderMenu();
  if (state.page === "overview") return renderOverview();
  if (state.page === "test") return renderTest();
  if (state.page === "done") return renderDone();
}

/* ---------------------- LOGIN ---------------------- */
function renderLogin() {
  app.innerHTML = `
    <header class="app-header">
      <div class="brand">
        <div class="brand-logo">S</div>
        <div class="brand-text">
          <h1>CEFR Speaking Lab</h1>
          <p>Your recording will be sent to the teacher</p>
        </div>
      </div>
    </header>

    <section class="card">
      <div class="input-grid">

        <div>
          <div class="field-label">First Name</div>
          <input id="firstName" class="field-input" placeholder="e.g. Doniyor">
        </div>

        <div>
          <div class="field-label">Surname</div>
          <input id="surname" class="field-input" placeholder="e.g. Eshmurodov">
        </div>

        <div>
          <div class="field-label">Group</div>
          <input id="group" class="field-input" placeholder="e.g. CEFR B1 ‚Äì Everest">
        </div>

      </div>

      <div style="margin-top:16px; text-align:right;">
        <button class="btn btn-primary" onclick="login()">Continue ‚Üí</button>
      </div>
    </section>
  `;
}

function login() {
  const f = document.getElementById("firstName").value.trim();
  const s = document.getElementById("surname").value.trim();
  const g = document.getElementById("group").value.trim();

  if (!f || !s || !g) return alert("Please enter all fields.");
  state.student.firstName = f;
  state.student.surname = s;
  state.student.group = g;
  state.page = "menu";
  render();
}

/* ---------------------- MENU ---------------------- */
function renderMenu() {
  app.innerHTML = `
    <header class="app-header">
      <div class="brand">
        <div class="brand-logo">S</div>
        <div class="brand-text">
          <h1>Main Menu</h1>
          <p>${state.student.firstName} ${state.student.surname} ‚Äî ${state.student.group}</p>
        </div>
      </div>
    </header>

    <section class="card">
      <h2>Select your speaking set</h2>

      <div class="set-grid">
        ${
          speakingSets.map(s => `
            <div class="set-card" onclick="startOverview(${s.id})">
              <div class="set-name">${s.name}</div>
              <div class="set-meta">${s.description}</div>
            </div>
          `).join("")
        }
      </div>
    </section>
  `;
}

function startOverview(id) {
  state.selectedSet = speakingSets.find(s => s.id === id);
  state.page = "overview";
  render();
}

/* ---------------------- OVERVIEW ---------------------- */
function renderOverview() {
  const set = state.selectedSet;
  app.innerHTML = `
    <header class="app-header">
      <div class="brand">
        <div class="brand-logo">S</div>
        <div class="brand-text">
          <h1>${set.name}</h1>
        </div>
      </div>
      <button class="btn btn-secondary" onclick="goMenu()">‚Üê Back</button>
    </header>

    <section class="card">
      <h2>Overview</h2>
      <p>When ready, click start speaking.</p>

      <div style="margin-top:14px; text-align:right;">
        <button class="btn btn-primary" onclick="startTest()">Start Speaking üéôÔ∏è</button>
      </div>
    </section>
  `;
}

function goMenu() {
  state.page = "menu";
  render();
}

/* ---------------------- TEST START ---------------------- */
async function startTest() {
  const stream = await navigator.mediaDevices.getUserMedia({ audio:true });

  state.mediaRecorder = new MediaRecorder(stream);
  state.mediaRecorder.ondataavailable = e => state.audioChunks.push(e.data);
  state.mediaRecorder.onstop = () => {
    state.audioBlob = new Blob(state.audioChunks, { type:"audio/webm" });
  };

  state.mediaRecorder.start();

  state.test = {
    part: "p11",
    phase: "read",
    questionIndex: 0,
    secondsLeft: 5,
    transitionTo: null
  };

  state.isRecording = true;
  state.page = "test";
  render();
  timer();
}

function timer() {
  clearInterval(state.timerId);
  state.timerId = setInterval(() => {
    if (state.test.secondsLeft > 0) {
      state.test.secondsLeft--;
      render();
    } else {
      nextStep();
    }
  }, 1000);
}

/* ---------------------- TEST LOGIC ---------------------- */
function nextStep() {
  const set = state.selectedSet;
  const t = state.test;

  /* ---- 4 second transitions ---- */
  if (t.phase === "transition") {
    if (t.transitionTo === "p12") {
      t.part = "p12"; t.phase = "read"; t.secondsLeft = 5;
    } else if (t.transitionTo === "p2") {
      t.part = "p2"; t.phase = "prep"; t.secondsLeft = 60;
    } else if (t.transitionTo === "p3") {
      t.part = "p3"; t.phase = "prep"; t.secondsLeft = 60;
    }
    t.transitionTo = null;
    render(); timer(); return;
  }

  /* ---- Part 1.1 ---- */
  if (t.part === "p11") {
    if (t.phase === "read") {
      t.phase = "speak"; t.secondsLeft = 30;
    } else {
      if (t.questionIndex < set.part1_1.length - 1) {
        t.questionIndex++; t.phase = "read"; t.secondsLeft = 5;
      } else {
        t.phase = "transition"; t.transitionTo = "p12"; t.secondsLeft = 4;
      }
    }
    render(); timer(); return;
  }

  /* ---- Part 1.2 ---- */
  if (t.part === "p12") {
    if (t.phase === "read") {
      t.phase = "speak";
      t.secondsLeft = t.questionIndex === 0 ? 45 : 30;
    } else {
      if (t.questionIndex < set.part1_2.questions.length - 1) {
        t.questionIndex++; t.phase = "read"; t.secondsLeft = 5;
      } else {
        t.phase = "transition"; t.transitionTo = "p2"; t.secondsLeft = 4;
      }
    }
    render(); timer(); return;
  }

  /* ---- Part 2 ---- */
  if (t.part === "p2") {
    if (t.phase === "prep") {
      t.phase = "speak"; t.secondsLeft = 120;
    } else {
      t.phase = "transition"; t.transitionTo = "p3"; t.secondsLeft = 4;
    }
    render(); timer(); return;
  }

  /* ---- Part 3 ---- */
  if (t.part === "p3") {
    if (t.phase === "prep") {
      t.phase = "speak"; t.secondsLeft = 120;
    } else {
      finishTest();
    }
    render(); timer(); return;
  }
}

/* ---------------------- RENDER TEST ---------------------- */
function renderTest() {
  const set = state.selectedSet;
  const t = state.test;

  app.innerHTML = `
    <header class="app-header">
      <div class="brand">
        <div class="brand-logo">S</div>
        <div class="brand-text">
          <h1>${set.name}</h1>
        </div>
      </div>
    </header>

    <section class="test-card">

      <h2>
        ${
          t.phase === "transition"
          ? `Let's move to ${(
              t.transitionTo === "p12" ? "Part 1.2" :
              t.transitionTo === "p2" ? "Part 2" :
              "Part 3"
            )}`
          : displayTestTitle()
        }
      </h2>

      <p style="margin-top:10px; opacity:.7;">
        ${
          t.phase === "transition"
          ? "Get ready. The next part starts automatically."
          : displayTestSubtitle()
        }
      </p>

      <div style="margin-top:20px; font-size:22px; text-align:center;">
        ${
          t.phase === "transition"
          ? ""
          : displayCurrentQuestion()
        }
      </div>

      ${
        (t.part === "p12" && t.phase !== "transition")
          ? `<div style="margin-top:20px;">
              <img src="${set.part1_2.image}" style="width:100%; border-radius:14px;">
            </div>`
          : ""
      }

      <div class="timer-row" style="margin-top:30px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div style="font-size:12px; color:var(--text-muted);">
            ${
              t.phase === "transition"
              ? "Next part begins in"
              : t.phase === "read"
                ? "Reading time"
                : t.phase === "prep"
                  ? "Preparation time"
                  : "Speaking time"
            }
          </div>
          <div style="font-size:32px; font-weight:700; color:var(--danger);">
            ${formatTime(t.secondsLeft)}
          </div>
        </div>

        <div id="wave" class="wave">
          ${Array.from({length:20}).map(()=>`<div class="wave-bar"></div>`).join("")}
        </div>
      </div>

    </section>
  `;
}

function displayTestTitle() {
  const t = state.test;
  if (t.part === "p11") return "Part 1.1 ‚Äì Short questions";
  if (t.part === "p12") return "Part 1.2 ‚Äì Picture questions";
  if (t.part === "p2") return "Part 2 ‚Äì Long turn";
  return "Part 3 ‚Äì Discussion";
}

function displayTestSubtitle() {
  const t = state.test;
  if (t.part === "p11") return "5 seconds to read, 30 seconds to answer.";
  if (t.part === "p12") return "Picture questions. 5 seconds to read.";
  if (t.part === "p2") return "1 minute to prepare, 2 minutes to speak.";
  return "1 minute to prepare, 2 minutes to speak.";
}

function displayCurrentQuestion() {
  const s = state.selectedSet;
  const t = state.test;

  if (t.part === "p11") return s.part1_1[t.questionIndex];

  if (t.part === "p12") return s.part1_2.questions[t.questionIndex];

  if (t.part === "p2") return s.part2.main;

  if (t.part === "p3") return s.part3.topic;
}

function formatTime(n) {
  const m = Math.floor(n / 60);
  const s = String(n % 60).padStart(2,"0");
  return `${m}:${s}`;
}

/* ---------------------- FINISH TEST ---------------------- */
function finishTest() {
  state.mediaRecorder.stop();
  state.page = "done";
  render();
  sendRecording();
}

/* ---------------------- COMPLETION SCREEN ---------------------- */
function renderDone() {
  app.innerHTML = `
    <header class="app-header">
      <div class="brand">
        <div class="brand-logo">S</div>
        <div class="brand-text">
          <h1>Finished</h1>
          <p>${state.student.firstName} ${state.student.surname}</p>
        </div>
      </div>
    </header>

    <section class="completion-screen">
      <h2>üéâ Great job!</h2>
      <p>Your recording is being sent to Telegram.</p>

      <div style="margin-top:18px;">
        <button class="btn btn-primary" onclick="downloadAudio()">Download Recording</button>
        <button class="btn btn-secondary" onclick="goMenu()">Main Menu</button>
      </div>
    </section>
  `;
}

function downloadAudio() {
  if (!state.audioBlob) return alert("No audio found");

  const url = URL.createObjectURL(state.audioBlob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "SpeakingTest.webm";
  a.click();
}

/* ---------------------- SEND TO TELEGRAM ---------------------- */
async function sendRecording() {
  const base64 = await blobToBase64(state.audioBlob);

  await fetch("/api/sendRecording", {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({
      firstName: state.student.firstName,
      surname: state.student.surname,
      group: state.student.group,
      setName: state.selectedSet.name,
      audioBase64: base64
    })
  });
}

function blobToBase64(blob) {
  return new Promise(res => {
    const reader = new FileReader();
    reader.onloadend = () => res(reader.result.split(",")[1]);
    reader.readAsDataURL(blob);
  });
}

/* ---------------------- START ---------------------- */
render();
</script>

</body>
</html>
