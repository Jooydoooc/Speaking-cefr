<script>
  const app = document.getElementById("app-root");

  // --- CONFIG: QUESTION SETS -----------------------------------
  const speakingSets = [
    {
      id: 1,
      name: "Speaking Set 1",
      active: true,
      description: "Daily routine & school mornings",
      part1_1: [
        "What time do you usually wake up?",
        "Do you like going to the park?",
        "What do you do when you feel tired?"
      ],
      part1_2: {
        image:
          "https://i.ibb.co/pr9hGkwx/Screenshot-2025-12-03-at-00-02-09.png",
        questions: [
          "What do you see in these pictures?",
          "Why do some people like waking up early?",
          "Which do you prefer, waking up early or late, and why?"
        ]
      },
      part2: {
        main: "Talk about a time when you were late for something important.",
        prompts: [
          "What happened and how did you feel?",
          "Why is being on time important?"
        ]
      },
      part3: {
        topic: "Should schools start later in the morning?",
        for: [
          "Students need more sleep to stay healthy",
          "Late classes can help improve focus",
          "It reduces morning stress and rushing"
        ],
        against: [
          "It may shorten study hours",
          "Parents might find schedules harder",
          "Students can become lazy"
        ]
      }
    },
    ...Array.from({ length: 9 }).map((_, i) => ({
      id: i + 2,
      name: `Speaking Set ${i + 2}`,
      active: false,
      comingSoon: true,
      description: "Coming soon"
    }))
  ];

  // --- STATE ---------------------------------------------------
  const state = {
    page: "login", // login | menu | overview | test | done
    student: {
      firstName: "",
      surname: "",
      group: "",
      date: new Date().toLocaleDateString("en-GB"),
      time: new Date().toLocaleTimeString("en-GB", {
        hour: "2-digit",
        minute: "2-digit"
      })
    },
    selectedSet: null,
    test: {
      part: null, // "p11" | "p12" | "p2" | "p3"
      questionIndex: 0,
      phase: null, // "read" | "speak" | "prep" | "transition"
      secondsLeft: 0,
      transitionTo: null // used only when phase === "transition"
    },
    timerId: null,
    isRecording: false,
    mediaRecorder: null,
    audioChunks: [],
    audioBlob: null,
    stream: null,
    audioContext: null,
    analyser: null,
    waveBars: Array.from({ length: 20 }, () => 5),
    blobPromise: null,
    blobResolve: null
  };

  // --- RENDER ROOT ---------------------------------------------
  function render() {
    if (state.page === "login") {
      renderLogin();
    } else if (state.page === "menu") {
      renderMenu();
    } else if (state.page === "overview") {
      renderOverview();
    } else if (state.page === "test") {
      renderTest();
    } else if (state.page === "done") {
      renderDone();
    }
  }

  // --- LOGIN ---------------------------------------------------
  function renderLogin() {
    app.innerHTML = `
      <header class="app-header">
        <div class="brand">
          <div class="brand-logo">S</div>
          <div class="brand-text">
            <h1>CEFR Speaking Lab</h1>
            <p>Teacher receives your recording on Telegram</p>
          </div>
        </div>
        <div class="chip">
          <span class="chip-dot"></span>
          Student login
        </div>
      </header>

      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Log in to start speaking</div>
            <div class="card-subtitle">
              Enter your details exactly. They are sent with your recording.
            </div>
          </div>
          <span class="badge badge-accent">Step 1</span>
        </div>

        <div class="input-grid">
          <div>
            <div class="field-label">First name</div>
            <input id="firstName" class="field-input" placeholder="e.g. Doniyor" value="${state.student.firstName}">
          </div>
          <div>
            <div class="field-label">Surname</div>
            <input id="surname" class="field-input" placeholder="e.g. Eshmurodov" value="${state.student.surname}">
          </div>
          <div>
            <div class="field-label">Group</div>
            <input id="group" class="field-input" placeholder="e.g. CEFR B1 ‚Äì Everest" value="${state.student.group}">
          </div>
        </div>

        <p class="helper-text">
          Example: <strong>CEFR B1 ‚Äì Evening</strong>, <strong>IELTS Intro ‚Äì 17:00</strong>, etc.
        </p>

        <div class="btn-row">
          <button class="btn btn-primary" onclick="handleLogin()">Continue to menu ‚Üí</button>
        </div>
      </section>
    `;
  }

  function handleLogin() {
    const firstName = document.getElementById("firstName").value.trim();
    const surname = document.getElementById("surname").value.trim();
    const group = document.getElementById("group").value.trim();

    if (!firstName || !surname || !group) {
      alert("Please fill in your first name, surname and group.");
      return;
    }

    state.student.firstName = firstName;
    state.student.surname = surname;
    state.student.group = group;
    state.page = "menu";
    render();
  }

  // --- MENU ----------------------------------------------------
  function renderMenu() {
    const activeCount = speakingSets.filter((s) => s.active).length;

    app.innerHTML = `
      <header class="app-header">
        <div class="brand">
          <div class="brand-logo">S</div>
          <div class="brand-text">
            <h1>Main Menu</h1>
            <p>${state.student.firstName || "Student"} ${
      state.student.surname || ""
    } ¬∑ ${state.student.group || "Group"}</p>
          </div>
        </div>
        <div class="chip">
          <span class="chip-dot"></span>
          ${activeCount} active set${activeCount !== 1 ? "s" : ""}
        </div>
      </header>

      <section class="menu-layout">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Choose your speaking set</div>
              <div class="card-subtitle">
                Only Set 1 is active now. Other sets are coming soon.
              </div>
            </div>
            <span class="badge">10 sets</span>
          </div>

          <div class="set-grid">
            ${speakingSets
              .map((set) => {
                if (!set.active) {
                  return `
                    <div class="set-card disabled">
                      <div class="set-label-row">
                        <div class="set-icon">${set.id}</div>
                        <div>
                          <div class="set-name">${set.name}</div>
                          <div class="set-meta">${set.description}</div>
                        </div>
                        <span class="pill-coming">Coming soon</span>
                      </div>
                    </div>
                  `;
                }
                return `
                  <div class="set-card" onclick="openSet(${set.id})">
                    <div class="set-label-row">
                      <div class="set-icon">${set.id}</div>
                      <div>
                        <div class="set-name">${set.name}</div>
                        <div class="set-meta">${set.description}</div>
                      </div>
                    </div>
                  </div>
                `;
              })
              .join("")}
          </div>
        </div>

        <aside class="info-block">
          <div class="info-title">How this test works</div>
          <ul class="info-list">
            <li>First you see all questions and the picture.</li>
            <li>Then you click <strong>Start speaking</strong>.</li>
            <li>You see one question at a time in full screen.</li>
            <li>Reading / preparation and speaking time are automatic.</li>
            <li>Your voice is recorded and sent to your teacher on Telegram.</li>
          </ul>

          <div class="stat-row">
            <div class="stat-pill">üìÖ ${state.student.date}</div>
            <div class="stat-pill">‚è∞ ${state.student.time}</div>
            <div class="stat-pill">üë§ ${state.student.firstName} ${
      state.student.surname
    }</div>
            <div class="stat-pill">üë• ${state.student.group}</div>
          </div>
        </aside>
      </section>
    `;
  }

  function openSet(id) {
    const set = speakingSets.find((s) => s.id === id);
    if (!set || !set.active) return;
    state.selectedSet = set;
    state.page = "overview";
    render();
  }

  // --- SET OVERVIEW --------------------------------------------
  function renderOverview() {
    const set = state.selectedSet;
    if (!set) {
      state.page = "menu";
      render();
      return;
    }

    app.innerHTML = `
      <header class="app-header">
        <div class="brand">
          <div class="brand-logo">S</div>
          <div class="brand-text">
            <h1>${set.name}</h1>
            <p>${state.student.firstName} ${state.student.surname} ¬∑ ${
      state.student.group
    }</p>
          </div>
        </div>
        <div class="btn-row" style="margin-top:0;">
          <button class="btn btn-secondary" onclick="backToMenu()">‚Üê Back</button>
          <button class="btn btn-primary" onclick="startTestFromOverview()">Start speaking üéôÔ∏è</button>
        </div>
      </header>

      <section class="set-overview-layout">
        <div class="section-block">
          <div class="section-title">Part 1.1 ‚Äì Short questions</div>
          <div class="section-sub">
            You will answer each question one by one. First you have 5 seconds to read, then 30 seconds to answer.
          </div>
          <ul class="question-list">
            ${set.part1_1.map((q, i) => `<li>${i + 1}. ${q}</li>`).join("")}
          </ul>

          <div style="margin-top:12px; border-top:1px dashed var(--border); padding-top:10px;">
            <div class="section-title">Part 1.2 ‚Äì Picture questions</div>
            <div class="section-sub">
              You have 5 seconds to read each question. For question 1 you get 45 seconds to answer, for questions 2 and 3 you get 30 seconds.
            </div>
            <div class="picture-wrapper">
              <img src="${set.part1_2.image}" alt="Part 1.2 picture">
            </div>
            <ul class="question-list" style="margin-top:8px;">
              ${set.part1_2.questions
                .map((q, i) => `<li>${i + 1}. ${q}</li>`)
                .join("")}
            </ul>
          </div>
        </div>

        <div class="section-block">
          <div class="section-title">Part 2 ‚Äì Long turn</div>
          <div class="section-sub">
            You will have 1 minute to prepare and 2 minutes to speak.
          </div>
          <p><strong>${set.part2.main}</strong></p>
          <ul class="question-list" style="margin-top:6px;">
            ${set.part2.prompts.map((p) => `<li>${p}</li>`).join("")}
          </ul>

          <div style="margin-top:14px; border-top:1px dashed var(--border); padding-top:10px;">
            <div class="section-title">Part 3 ‚Äì Discussion</div>
            <div class="section-sub">
              Topic: <strong>${set.part3.topic}</strong><br>
              1 minute to prepare and 2 minutes to discuss.
            </div>
            <div class="columns-two">
              <div class="for-block">
                <div class="for-title">FOR</div>
                <ul class="mini-list">
                  ${set.part3.for.map((p) => `<li>${p}</li>`).join("")}
                </ul>
              </div>
              <div class="against-block">
                <div class="against-title">AGAINST</div>
                <ul class="mini-list">
                  ${set.part3.against.map((p) => `<li>${p}</li>`).join("")}
                </ul>
              </div>
            </div>
          </div>

          <div class="overview-footer">
            <span>
              When you click <strong>Start speaking</strong>, your microphone turns on and the timer starts.
            </span>
            <span>Parts run automatically: 1.1 ‚Üí 1.2 ‚Üí 2 ‚Üí 3.</span>
          </div>
        </div>
      </section>
    `;
  }

  function backToMenu() {
    state.selectedSet = null;
    state.page = "menu";
    render();
  }

  // --- TEST FLOW & TIMERS -------------------------------------
  function startTestFromOverview() {
    const set = state.selectedSet;
    if (!set) return;
    startRecordingAndTest();
  }

  async function startRecordingAndTest() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      state.stream = stream;
      state.mediaRecorder = new MediaRecorder(stream);
      state.audioChunks = [];
      state.audioBlob = null;

      state.blobPromise = new Promise((resolve) => {
        state.blobResolve = resolve;
      });

      state.mediaRecorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) {
          state.audioChunks.push(e.data);
        }
      };

      state.mediaRecorder.onstop = () => {
        const mime =
          state.audioChunks[0]?.type ||
          state.mediaRecorder.mimeType ||
          "audio/webm";
        const blob = new Blob(state.audioChunks, { type: mime });
        state.audioBlob = blob;
        if (state.blobResolve) {
          state.blobResolve(blob);
          state.blobResolve = null;
        }
      };

      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      state.audioContext = new AudioCtx();
      const source = state.audioContext.createMediaStreamSource(stream);
      state.analyser = state.audioContext.createAnalyser();
      state.analyser.fftSize = 256;
      source.connect(state.analyser);

      state.isRecording = true;
      state.mediaRecorder.start();

      state.test.part = "p11";
      state.test.questionIndex = 0;
      state.test.phase = "read";
      state.test.secondsLeft = 5;
      state.test.transitionTo = null;

      state.page = "test";
      render();
      startVisualizer();
      startTimer();
    } catch (err) {
      console.error(err);
      alert(
        "Could not access your microphone. Please allow microphone access and try again."
      );
    }
  }

  function startVisualizer() {
    if (!state.analyser) return;

    const bufferLength = state.analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);

    function draw() {
      if (!state.analyser || !state.isRecording) return;
      state.analyser.getByteFrequencyData(dataArray);

      state.waveBars = state.waveBars.map((_, index) => {
        const idx = Math.floor(index * (bufferLength / state.waveBars.length));
        const value = dataArray[idx] / 255;
        return Math.max(5, Math.floor(value * 26));
      });

      const el = document.getElementById("wave");
      if (el) {
        el.innerHTML = state.waveBars
          .map((h) => `<div class="wave-bar" style="height:${h}px"></div>`)
          .join("");
      }

      requestAnimationFrame(draw);
    }

    draw();
  }

  function startTimer() {
    clearInterval(state.timerId);
    state.timerId = setInterval(() => {
      if (state.test.secondsLeft > 0) {
        state.test.secondsLeft -= 1;
        render();
      } else {
        advanceTestState();
      }
    }, 1000);
  }

  function advanceTestState() {
    const set = state.selectedSet;
    const t = state.test;

    // 1Ô∏è‚É£ Handle transition screens (4 seconds)
    if (t.phase === "transition" && t.transitionTo) {
      const target = t.transitionTo;

      if (target === "p12") {
        t.part = "p12";
        t.questionIndex = 0;
        t.phase = "read";
        t.secondsLeft = 5;
      } else if (target === "p2") {
        t.part = "p2";
        t.questionIndex = 0;
        t.phase = "prep";
        t.secondsLeft = 60;
      } else if (target === "p3") {
        t.part = "p3";
        t.questionIndex = 0;
        t.phase = "prep";
        t.secondsLeft = 60;
      }

      t.transitionTo = null;
      render();
      startTimer();
      return;
    }

    // 2Ô∏è‚É£ Normal flow for each part
    if (t.part === "p11") {
      // Part 1.1
      if (t.phase === "read") {
        t.phase = "speak";
        t.secondsLeft = 30;
      } else {
        if (t.questionIndex < set.part1_1.length - 1) {
          t.questionIndex += 1;
          t.phase = "read";
          t.secondsLeft = 5;
        } else {
          // üëâ Transition screen to Part 1.2
          t.phase = "transition";
          t.transitionTo = "p12";
          t.secondsLeft = 4;
        }
      }
    } else if (t.part === "p12") {
      // Part 1.2
      if (t.phase === "read") {
        t.phase = "speak";
        t.secondsLeft = t.questionIndex === 0 ? 45 : 30;
      } else {
        if (t.questionIndex < set.part1_2.questions.length - 1) {
          t.questionIndex += 1;
          t.phase = "read";
          t.secondsLeft = 5;
        } else {
          // üëâ Transition screen to Part 2
          t.phase = "transition";
          t.transitionTo = "p2";
          t.secondsLeft = 4;
        }
      }
    } else if (t.part === "p2") {
      // Part 2
      if (t.phase === "prep") {
        t.phase = "speak";
        t.secondsLeft = 120;
      } else {
        // üëâ Transition screen to Part 3
        t.phase = "transition";
        t.transitionTo = "p3";
        t.secondsLeft = 4;
      }
    } else if (t.part === "p3") {
      // Part 3
      if (t.phase === "prep") {
        t.phase = "speak";
        t.secondsLeft = 120;
      } else {
        // End of test
        finishTest();
        return;
      }
    }

    render();
    startTimer();
  }

  async function finishTest() {
    clearInterval(state.timerId);

    if (state.mediaRecorder && state.isRecording) {
      try {
        state.mediaRecorder.stop();
      } catch {}
      if (state.blobPromise) {
        try {
          await state.blobPromise;
        } catch {}
      }
    }

    if (state.audioContext) {
      try {
        await state.audioContext.close();
      } catch {}
    }
    if (state.stream) {
      state.stream.getTracks().forEach((t) => t.stop());
      state.stream = null;
    }

    state.isRecording = false;
    state.page = "done";
    render();
    sendToTelegram();
  }

  // --- TEST RENDER ---------------------------------------------
  function renderTest() {
    const set = state.selectedSet;
    const t = state.test;
    if (!set) {
      state.page = "menu";
      render();
      return;
    }

    const { title, subtitle, questionText, extraHtml, showImage, progress } =
      buildTestView(set, t);

    app.innerHTML = `
      <header class="app-header">
        <div class="brand">
          <div class="brand-logo">S</div>
          <div class="brand-text">
            <h1>${set.name}</h1>
            <p>${state.student.firstName} ${state.student.surname} ¬∑ ${
      state.student.group
    }</p>
          </div>
        </div>
        <button class="btn btn-secondary" onclick="finishTest()">Finish now</button>
      </header>

      <section class="test-card">
        <div class="test-top-row">
          <div>
            <div class="test-title">${title}</div>
            <div class="test-subtitle">${subtitle}</div>
            <div class="progress-bar">
              <div class="progress-inner" style="width:${progress}%"></div>
            </div>
          </div>
          <div class="record-indicator">
            <span class="record-dot"></span>
            <span>Recording</span>
          </div>
        </div>

        <div class="test-main">
          <div class="test-part-label">${phaseLabel(t)}</div>
          <div class="test-question">${questionText}</div>
          ${
            extraHtml
              ? `<div class="test-extra">${extraHtml}</div>`
              : ""
          }
          ${
            showImage
              ? `<div class="test-image"><img src="${set.part1_2.image}" alt="Picture for Part 1.2"></div>`
              : ""
          }
        </div>

        <div class="timer-row">
          <div>
            <div class="timer-label">${timerLabel(t)}</div>
            <div class="timer-value">${formatTime(t.secondsLeft)}</div>
          </div>
          <div id="wave" class="wave">
            ${state.waveBars
              .map((h) => `<div class="wave-bar" style="height:${h}px"></div>`)
              .join("")}
          </div>
        </div>

        <div class="test-footer">
          <span>Test runs automatically. Just watch the timer and keep speaking.</span>
          <span>Current part: ${simplePartName(t.part)}</span>
        </div>
      </section>
    `;
  }

  function buildTestView(set, t) {
    let title = "";
    let subtitle = "";
    let questionText = "";
    let extraHtml = "";
    let showImage = false;
    let progress = 0;

    const totalSteps =
      set.part1_1.length +
      set.part1_2.questions.length +
      2 + // Part 2 prep + speak
      2; // Part 3 prep + speak

    let currentStepIndex = 0;

    if (t.part === "p11") {
      currentStepIndex = t.questionIndex;
    } else if (t.part === "p12") {
      currentStepIndex = set.part1_1.length + t.questionIndex;
    } else if (t.part === "p2") {
      currentStepIndex = set.part1_1.length + set.part1_2.questions.length;
      if (t.phase === "speak") currentStepIndex += 1;
    } else if (t.part === "p3") {
      currentStepIndex =
        set.part1_1.length + set.part1_2.questions.length + 2;
      if (t.phase === "speak") currentStepIndex += 1;
    }

    progress = Math.min(
      100,
      ((currentStepIndex + 1) / totalSteps) * 100
    );

    // üß© Special view for 4-second transitions
    if (t.phase === "transition" && t.transitionTo) {
      const targetName = simplePartName(t.transitionTo);
      title = "Moving to the next part";
      subtitle = "Please get ready. The next part will start automatically.";
      questionText = `Let‚Äôs move to ${targetName}.`;
      extraHtml =
        "Stay focused and be ready to speak as soon as the next part begins.";
      showImage = false; // keep screen clean during transitions
      return { title, subtitle, questionText, extraHtml, showImage, progress };
    }

    if (t.part === "p11") {
      title = "Part 1.1 ‚Äì Short questions";
      subtitle = "5 seconds to read, 30 seconds to answer each question.";
      questionText = set.part1_1[t.questionIndex];
    } else if (t.part === "p12") {
      title = "Part 1.2 ‚Äì Picture questions";
      subtitle =
        "Look at the picture. 5 seconds to read, then answer the question.";
      questionText = set.part1_2.questions[t.questionIndex];
      showImage = true;
    } else if (t.part === "p2") {
      title = "Part 2 ‚Äì Long turn";
      subtitle =
        "You have 1 minute to prepare and then 2 minutes to speak.";
      questionText = set.part2.main;

      const promptsHtml = `
        <ul class="mini-list">
          ${set.part2.prompts.map((p) => `<li>${p}</li>`).join("")}
        </ul>
      `;

      if (t.phase === "prep") {
        extraHtml = `
          <p>Use the points below to plan your answer:</p>
          ${promptsHtml}
        `;
      } else {
        extraHtml = `
          <p>While you speak, try to cover these points:</p>
          ${promptsHtml}
        `;
      }
    } else if (t.part === "p3") {
      title = "Part 3 ‚Äì Discussion";
      subtitle =
        "1 minute to prepare ideas, then 2 minutes to discuss both sides.";
      questionText = set.part3.topic;

      const forAgainstHtml = `
        <div class="columns-two">
          <div class="for-block">
            <div class="for-title">FOR</div>
            <ul class="mini-list">
              ${set.part3.for.map((p) => `<li>${p}</li>`).join("")}
            </ul>
          </div>
          <div class="against-block">
            <div class="against-title">AGAINST</div>
            <ul class="mini-list">
              ${set.part3.against.map((p) => `<li>${p}</li>`).join("")}
            </ul>
          </div>
        </div>
      `;

      if (t.phase === "prep") {
        extraHtml = `
          <p>Look at the arguments for and against. Decide which side you agree with and plan your reasons.</p>
          ${forAgainstHtml}
        `;
      } else {
        extraHtml = `
          <p>Use these points while speaking. Explain both sides and then give your own opinion.</p>
          ${forAgainstHtml}
        `;
      }
    }

    return { title, subtitle, questionText, extraHtml, showImage, progress };
  }

  function phaseLabel(t) {
    if (t.phase === "transition") return "Moving to next part";
    if (t.part === "p2" || t.part === "p3") {
      if (t.phase === "prep") return "Preparation time";
      return "Speaking time";
    }
    if (t.phase === "read") return "Reading the question";
    return "Speaking";
  }

  function timerLabel(t) {
    if (t.phase === "transition") return "Next part starts in";
    if (t.part === "p2" || t.part === "p3") {
      return t.phase === "prep" ? "Preparation time" : "Speaking time";
    }
    return t.phase === "read" ? "Reading time" : "Speaking time";
  }

  function simplePartName(part) {
    if (part === "p11") return "Part 1.1";
    if (part === "p12") return "Part 1.2";
    if (part === "p2") return "Part 2";
    if (part === "p3") return "Part 3";
    return "";
  }

  function formatTime(sec) {
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return `${m}:${s.toString().padStart(2, "0")}`;
  }

  // --- COMPLETION ----------------------------------------------
  function renderDone() {
    app.innerHTML = `
      <header class="app-header">
        <div class="brand">
          <div class="brand-logo">S</div>
          <div class="brand-text">
            <h1>Speaking test finished</h1>
            <p>${state.student.firstName} ${state.student.surname} ¬∑ ${
      state.student.group
    }</p>
          </div>
        </div>
      </header>

      <section class="completion-screen">
        <h2>‚úÖ Great job!</h2>
        <p>
          Your test is complete. The recording is being sent to your teacher on Telegram.
          You can also download it for your own practice.
        </p>
        <div class="btn-row" style="justify-content:center;">
          <button class="btn btn-primary" onclick="downloadRecording()">Download my recording</button>
          <button class="btn btn-secondary" onclick="backToMenuAfterDone()">Back to main menu</button>
        </div>
      </section>
    `;
  }

  function backToMenuAfterDone() {
    state.page = "menu";
    render();
  }

  function downloadRecording() {
    if (!state.audioBlob) {
      alert("No recording file found.");
      return;
    }
    const setId = state.selectedSet ? state.selectedSet.id : 1;
    const fileName = `${state.student.firstName}_${state.student.surname}_${state.student.group}_Set${setId}_${state.student.date.replace(
      /\//g,
      "-"
    )}_${state.student.time.replace(/:/g, "-")}.webm`;
    const url = URL.createObjectURL(state.audioBlob);
    const a = document.createElement("a");
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // --- TELEGRAM API CALL ---------------------------------------
  async function sendToTelegram() {
    if (!state.audioBlob || !state.selectedSet) return;

    try {
      const base64Audio = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const result = reader.result || "";
          const base64 =
            typeof result === "string" && result.includes(",")
              ? result.split(",")[1]
              : result;
          resolve(base64);
        };
        reader.onerror = () =>
          reject(reader.error || new Error("Failed to read audio"));
        reader.readAsDataURL(state.audioBlob);
      });

      const res = await fetch("/api/sendRecording", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          firstName: state.student.firstName,
          surname: state.student.surname,
          group: state.student.group,
          setName: state.selectedSet.name,
          date: state.student.date,
          time: state.student.time,
          audioBase64: base64Audio
        })
      });

      const data = await res.json();
      if (!res.ok || !data.ok) {
        console.error("Telegram error:", data);
        alert(
          "Recording saved, but sending to Telegram failed. Please tell your teacher."
        );
      }
    } catch (err) {
      console.error("sendToTelegram error:", err);
      alert(
        "Recording saved, but sending to Telegram failed. Please tell your teacher."
      );
    }
  }

  // --- GLOBALS FOR INLINE HANDLERS -----------------------------
  window.handleLogin = handleLogin;
  window.openSet = openSet;
  window.backToMenu = backToMenu;
  window.startTestFromOverview = startTestFromOverview;
  window.finishTest = finishTest;
  window.downloadRecording = downloadRecording;
  window.backToMenuAfterDone = backToMenuAfterDone;

  // initial render
  render();
</script>
